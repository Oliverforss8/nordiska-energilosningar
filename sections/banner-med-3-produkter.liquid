{% liquid
  assign section_id = section.settings.custom_id | default: section.id
  assign section_class = 'banner-med-3-produkter'
  assign layout_reversed = false
  if section.settings.layout_direction == 'products_first'
    assign layout_reversed = true
  endif
%}

<div class="">
  <section
    id="{{ section_id }}"
    class="{{ section_class }} layout py-[60px] md:py-[85px]"
  >
    {% comment %} Banner Content {% endcomment %}
    <div
      class="banner-content  relative h-[500px] w-full rounded-[10px] bg-cover bg-center bg-no-repeat p-[20px]  md:px-[50px] md:py-[40px] {% if layout_reversed %}order-2{% else %}order-1{% endif %}"
      style="background-color: {{ section.settings.background_color }}; {% if section.settings.background_image %}background-image: url({{ section.settings.background_image | image_url: width: 1200 }});{% endif %}"
      data-debug="layout_reversed: {{ layout_reversed }}, setting: {{ section.settings.layout_direction }}"
    >
      {% if section.settings.background_image and section.settings.overlay_opacity > 0 %}
        <div
          class="absolute inset-0 rounded-[10px]"
          style="background-color: #171717; opacity: {{ section.settings.overlay_opacity | divided_by: 100.0 }};"
        ></div>
      {% endif %}
      <div class="relative z-10 flex h-full flex-col justify-between">
        <div>
          {% if section.settings.header_button_text != blank %}
            <a
              href="{{ section.settings.header_button_url }}"
              class="knappetikett2 z-10 inline-block rounded-[10px] bg-transparent p-[15px] text-white"
              style="border: 1px solid #fff;"
            >
              {{ section.settings.header_button_text }}
            </a>
          {% endif %}
        </div>
        <div class="flex flex-col gap-[30px] lg:w-[840px]">
          {% if section.settings.heading != blank %}
            <h2 class="headline2 text-white ">
              {{ section.settings.heading }}
            </h2>
          {% endif %}
          {% if section.settings.description != blank %}
            <p class="knappetikett text-white">
              {{ section.settings.description }}
            </p>
          {% endif %}
          <div class="flex flex-row gap-[10px]">
            {% if section.settings.primary_button_text != blank %}
              <a
                href="{{ section.settings.primary_button_url }}"
                class="knappetikett flex shrink-0 flex-row items-center gap-[20px] rounded-full px-[20px] py-[17px] text-[#171717]"
                style="background: linear-gradient(135deg, #FFA94D 0%, #FF4E33 100%);"
              >
                {{ section.settings.primary_button_text }}
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="18"
                  viewBox="0 0 22 18"
                  fill="none"
                >
                  <path d="M1 8.99991H21L13.1739 1.17383" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M1 9.00009H21L13.1739 16.8262" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
            {% endif %}
            {% if section.settings.secondary_button_text != blank %}
              <a
                href="{{ section.settings.secondary_button_url }}"
                class="knappetikett flex shrink-0 flex-row items-center gap-[20px] rounded-[10px] bg-transparent px-[20px] py-[17px] text-white"
                style="border: 1px solid #fff;"
              >
                {{ section.settings.secondary_button_text }}
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="22"
                  height="18"
                  viewBox="0 0 22 18"
                  fill="none"
                >
                  <path d="M1 8.99991H21L13.1739 1.17383" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  <path d="M1 8.9996H21L13.1739 16.8257" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
              </a>
            {% endif %}
          </div>
        </div>
      </div>
    </div>

    {% comment %} Products Content {% endcomment %}
    <div
      class="products-content {% if layout_reversed %}order-1{% else %}order-2{% endif %}"
      data-debug="products order: {% if layout_reversed %}1{% else %}2{% endif %}"
    >
      <!-- Mobile carousel container -->
      <div class=" relative md:hidden">
        <div class="carousel-container overflow-hidden">
          <div
            class="carousel-track flex transition-transform duration-500 ease-in-out"
            data-current="0"
          >
            {% for block in section.blocks %}
              <div
                class="product-card flex w-full flex-shrink-0 flex-col-reverse rounded-[10px] p-[30px]"
                style="background: #F3F1E8;"
                {{ block.shopify_attributes }}
              >
                <div class="flex flex-col justify-between ">
                  <div class="flex flex-col">
                    {% liquid
                      assign card_title = block.settings.title
                      assign card_description = block.settings.description
                      assign card_url = block.settings.learn_more_url

                      if block.settings.product != blank
                        assign product = block.settings.product
                        assign card_title = product.title
                        assign card_description = product.description | strip_html | truncatewords: 15
                        assign card_url = product.url
                      endif
                    %}
                    {% if card_title != blank %}
                      <div class="headline1 pt-[30px] text-[36px] text-[#171717]">
                        {{ card_title }}
                      </div>
                    {% endif %}
                    {% if card_description != blank %}
                      <div class="text py-[20px] text-[#171717]/75">
                        {{ card_description }}
                      </div>
                    {% endif %}
                  </div>
                  <div class="flex shrink-0 gap-[10px]">
                    {% if card_url != blank %}
                      <a
                        href="{{ card_url }}"
                        class="banner-3-learn-more-btn knappetikett flex flex-row items-center gap-[20px] rounded-full px-[20px] py-[18px] text-[#171717]"
                      >
                        {{ block.settings.learn_more_text | default: 'Läs mer' }}
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="22"
                          height="18"
                          viewBox="0 0 22 18"
                          fill="none"
                        >
                          <path d="M1 8.99991H21L13.1739 1.17383" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M1 8.9996H21L13.1739 16.8257" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                      </a>
                    {% endif %}
                  </div>
                </div>
                <div
                  class=" "
                  style="
                        aspect-ratio: 18/23;
                    height: 285.081px;
                  "
                >
                  {% if block.settings.product != blank %}
                    {% assign product = block.settings.product %}
                    {% if product.featured_image %}
                      <img
                        src="{{ product.featured_image | image_url: width: 300 }}"
                        alt="{{ product.featured_image.alt | default: product.title }}"
                        width="200"
                        height="200"
                        class=" h-full w-full rounded-[5px] object-contain"
                        loading="lazy"
                      >
                    {% else %}
                      <div class="flex h-[200px] w-[200px] items-center justify-center rounded-[5px] bg-gray-200 text-gray-500">
                        {{ 'products.product.media.load_image' | t | default: 'Load image' }}
                      </div>
                    {% endif %}
                  {% else %}
                    <div class="flex h-full w-[200px] items-center justify-center rounded-[5px] bg-gray-200 text-gray-500">
                      {{
                        'sections.banner_with_products.no_product_selected'
                        | t
                        | default: 'No product selected'
                      }}
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Desktop grid -->
      <div
        class=" hidden grid-cols-3  gap-[20px] md:grid"
        id="desktop-products-grid-{{ section.id }}"
      >
        {% for block in section.blocks %}
          <div
            class="product-card flex flex-col-reverse rounded-[10px]  p-[30px] transition-colors duration-300{% if forloop.first %} active{% endif %}"
            {{ block.shopify_attributes }}
            data-card-index="{{ forloop.index0 }}"
          >
            <div class="flex flex-col justify-between ">
              <div class="flex flex-col">
                {% liquid
                  assign card_title = block.settings.title
                  assign card_description = block.settings.description
                  assign card_url = block.settings.learn_more_url

                  if block.settings.product != blank
                    assign product = block.settings.product
                    assign card_title = product.title
                    assign card_description = product.description | strip_html | truncatewords: 15
                    assign card_url = product.url
                  endif
                %}
                {% if card_title != blank %}
                  <div class="headline1 pt-[40px] text-[36px] text-[#171717] xl:pt-0">
                    {{ card_title }}
                  </div>
                {% endif %}
                {% if card_description != blank %}
                  <div class="text py-[20px] text-[#171717]/75 xl:pt-[40px]">
                    {{ card_description }}
                  </div>
                {% endif %}
              </div>
              <div class="flex shrink-0 gap-[10px]">
                {% if card_url != blank %}
                  <a
                    href="{{ card_url }}"
                    class="banner-3-learn-more-btn knappetikett flex shrink-0 flex-row items-center gap-[20px] whitespace-nowrap rounded-full px-[20px] py-[18px] text-[#171717]"
                  >
                    {{ block.settings.learn_more_text | default: 'Läs mer' }}
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="22"
                      height="18"
                      viewBox="0 0 22 18"
                      fill="none"
                    >
                      <path d="M1 8.99991H21L13.1739 1.17383" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      <path d="M1 8.9996H21L13.1739 16.8257" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </a>
                {% endif %}
              </div>
            </div>
            <div
              class=" "
              style="
                    aspect-ratio: 18/23;
                height: 285.081px;
              "
            >
              {% if block.settings.product != blank %}
                {% assign product = block.settings.product %}
                {% if product.featured_image %}
                  <img
                    src="{{ product.featured_image | image_url: width: 300 }}"
                    alt="{{ product.featured_image.alt | default: product.title }}"
                    width="200"
                    height="200"
                    class=" h-full w-full rounded-[5px] object-contain"
                    loading="lazy"
                  >
                {% else %}
                  <div class="flex h-[200px] w-[200px] items-center justify-center rounded-[5px] bg-gray-200 text-gray-500">
                    {{ 'products.product.media.load_image' | t | default: 'Load image' }}
                  </div>
                {% endif %}
              {% else %}
                <div class="flex h-full w-[200px] items-center justify-center rounded-[5px] bg-gray-200 text-gray-500">
                  {{
                    'sections.banner_with_products.no_product_selected'
                    | t
                    | default: 'No product selected'
                  }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Carousel navigation (only show on mobile) -->
      <div class="flex flex-row gap-[20px] pl-[20px] pt-[20px] md:hidden">
        <div class="carousel-prev translate-x-[-1] cursor-pointer">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="26"
            height="21"
            viewBox="0 0 26 21"
            fill="none"
          >
            <path d="M25 10.3915H1M1 10.3915L10.3913 1M1 10.3915L10.3913 19.7826" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
        <div class="carousel-next cursor-pointer">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="26"
            height="21"
            viewBox="0 0 26 21"
            fill="none"
          >
            <path d="M1 10.3915H25M25 10.3915L15.6087 1M25 10.3915L15.6087 19.7826" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </div>
      </div>
    </div>
  </section>
</div>

{% stylesheet %}
  .banner-med-3-produkter {
    display: flex !important;
    flex-direction: column !important;
    gap: 20px;
  }

  .banner-content.order-1 {
    order: 1 !important;
  }

  .banner-content.order-2 {
    order: 2 !important;
  }

  .products-content.order-1 {
    order: 1 !important;
  }

  .products-content.order-2 {
    order: 2 !important;
  }

  .banner-med-3-produkter a {
    text-decoration: none;
  }

  .banner-med-3-produkter a:hover {
    text-decoration: none;
  }

  .product-card .banner-3-learn-more-btn {
    background: linear-gradient(135deg, #ffa94d 0%, #ff4e33 100%);
    color: #171717;
    transition: all 0.3s ease;
  }

  .product-card.active .banner-3-learn-more-btn,
  .product-card:hover .banner-3-learn-more-btn,
  .product-card .banner-3-learn-more-btn.banner-3-active {
    background: linear-gradient(135deg, #ffa94d 0%, #ff4e33 100%) !important;
    border: none !important;
    color: #171717 !important;
  }

  /* More specific override to ensure gradient is applied */
  .banner-med-3-produkter .product-card.active .banner-3-learn-more-btn,
  .banner-med-3-produkter .product-card:hover .banner-3-learn-more-btn {
    background: linear-gradient(135deg, #ffa94d 0%, #ff4e33 100%) !important;
    border: none !important;
    border-color: transparent !important;
  }

  .product-card.active .banner-3-learn-more-btn svg path,
  .product-card:hover .banner-3-learn-more-btn svg path,
  .product-card .banner-3-learn-more-btn.banner-3-active svg path {
    stroke: #171717 !important;
  }

  /* Card background transition */
  .product-card {
    transition: background-color 0.3s ease;
  }

  .product-card.active,
  .product-card:hover {
    background-color: #f3f1e8 !important;
  }

  .carousel-container {
    position: relative;
  }

  .carousel-track {
    transition: transform 0.5s ease-in-out;
  }

  .carousel-prev,
  .carousel-next {
    transition: all 0.2s ease-in-out;
    border: none;
    outline: none;
  }

  .carousel-prev:hover,
  .carousel-next:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .carousel-prev:active,
  .carousel-next:active {
    transform: scale(0.95);
  }

  .carousel-prev:disabled,
  .carousel-next:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  .carousel-prev:disabled:hover,
  .carousel-next:disabled:hover {
    transform: none;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
  }
{% endstylesheet %}

{% javascript %}
  document.addEventListener('DOMContentLoaded', function () {
    // Find all carousel sections and initialize each one
    const carouselSections = document.querySelectorAll('.banner-med-3-produkter');

    carouselSections.forEach(function (section) {
      const carousel = section.querySelector('.carousel-track');
      const prevButton = section.querySelector('.carousel-prev');
      const nextButton = section.querySelector('.carousel-next');

      if (!carousel || !prevButton || !nextButton) return;

      const slides = carousel.querySelectorAll('.product-card');
      const totalSlides = slides.length;
      let currentSlide = 0;
      let autoChangeInterval;

      function updateCarousel() {
        const translateX = -currentSlide * 100;
        carousel.style.transform = `translateX(${translateX}%)`;
        carousel.setAttribute('data-current', currentSlide);

        // Update button states
        prevButton.disabled = currentSlide === 0;
        nextButton.disabled = currentSlide === totalSlides - 1;

        // Add visual feedback for disabled state
        if (prevButton.disabled) {
          prevButton.style.opacity = '0.5';
          prevButton.style.cursor = 'not-allowed';
        } else {
          prevButton.style.opacity = '1';
          prevButton.style.cursor = 'pointer';
        }

        if (nextButton.disabled) {
          nextButton.style.opacity = '0.5';
          nextButton.style.cursor = 'not-allowed';
        } else {
          nextButton.style.opacity = '1';
          nextButton.style.cursor = 'pointer';
        }
      }

      function nextSlide() {
        if (currentSlide < totalSlides - 1) {
          currentSlide++;
          updateCarousel();
        }
      }

      function prevSlide() {
        if (currentSlide > 0) {
          currentSlide--;
          updateCarousel();
        }
      }

      function startAutoChange() {
        if (totalSlides > 1) {
          autoChangeInterval = setInterval(nextSlide, 8000); // 8 seconds
        }
      }

      function stopAutoChange() {
        if (autoChangeInterval) {
          clearInterval(autoChangeInterval);
        }
      }

      function restartAutoChange() {
        stopAutoChange();
        startAutoChange();
      }

      // Event listeners
      nextButton.addEventListener('click', function (e) {
        e.preventDefault();
        nextSlide();
        restartAutoChange(); // Restart timer when user interacts
      });

      prevButton.addEventListener('click', function (e) {
        e.preventDefault();
        prevSlide();
        restartAutoChange(); // Restart timer when user interacts
      });

      // Pause auto-change on hover
      const carouselContainer = section.querySelector('.carousel-container');
      if (carouselContainer) {
        carouselContainer.addEventListener('mouseenter', stopAutoChange);
        carouselContainer.addEventListener('mouseleave', startAutoChange);
      }

      // Initialize carousel
      updateCarousel();

      // Start auto-change
      startAutoChange();

      // Handle touch events for swipe gestures
      let startX = 0;
      let isDragging = false;

      carousel.addEventListener('touchstart', function (e) {
        startX = e.touches[0].clientX;
        isDragging = true;
        stopAutoChange();
      });

      carousel.addEventListener('touchmove', function (e) {
        if (!isDragging) return;
        e.preventDefault();
      });

      carousel.addEventListener('touchend', function (e) {
        if (!isDragging) return;
        isDragging = false;

        const endX = e.changedTouches[0].clientX;
        const diffX = startX - endX;

        if (Math.abs(diffX) > 50) {
          // Minimum swipe distance
          if (diffX > 0) {
            nextSlide();
          } else {
            prevSlide();
          }
        }

        restartAutoChange();
      });
    });

    // Handle desktop product card hover behavior - EXACT same logic as collection page
    const bannerSections = document.querySelectorAll('.banner-med-3-produkter');

    bannerSections.forEach(function (section) {
      // Get desktop grid container
      const desktopGrid = section.querySelector('[id^="desktop-products-grid-"]');
      if (!desktopGrid) return;

      const productCards = desktopGrid.querySelectorAll('.product-card');

      if (productCards.length === 0) return;

      productCards.forEach(function (card) {
        card.addEventListener('mouseenter', function () {
          // Remove active class from all cards
          productCards.forEach(function (otherCard) {
            otherCard.classList.remove('active');
          });

          // Add active class to hovered card
          this.classList.add('active');
        });
      });

      // Handle mouse leave from the entire grid to reset to first item
      desktopGrid.addEventListener('mouseleave', function () {
        // Remove active class from all cards
        productCards.forEach(function (card) {
          card.classList.remove('active');
        });

        // Add active class back to first card
        if (productCards.length > 0) {
          productCards[0].classList.add('active');
        }
      });
    });
  });
{% endjavascript %}

{% schema %}
{
  "name": "Banner med 3 produkter",
  "tag": "section",
  "class": "banner-med-3-produkter",
  "max_blocks": 3,
  "blocks": [
    {
      "type": "product_card",
      "name": "Product Card",
      "settings": [
        {
          "type": "product",
          "id": "product",
          "label": "Select Product"
        },
        {
          "type": "text",
          "id": "title",
          "label": "Product Title (Fallback)",
          "default": "Laddbox",
          "info": "Only used if no product is selected. Will be replaced by the product's title automatically."
        },
        {
          "type": "textarea",
          "id": "description",
          "label": "Product Description (Fallback)",
          "default": "Lagra din egen solenergi och använd den när elpriserna är som högst.",
          "info": "Only used if no product is selected. Will be replaced by the product's description (first 15 words) automatically."
        },
        {
          "type": "text",
          "id": "learn_more_text",
          "label": "Learn More Button Text",
          "default": "Läs mer"
        },
        {
          "type": "url",
          "id": "learn_more_url",
          "label": "Learn More Button URL (Fallback)",
          "info": "Only used if no product is selected. Will be replaced by the product URL automatically."
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Layout Settings"
    },
    {
      "type": "select",
      "id": "layout_direction",
      "label": "Layout Direction",
      "options": [
        {
          "value": "banner_first",
          "label": "Banner First (Default)"
        },
        {
          "value": "products_first",
          "label": "Products First (Reversed)"
        }
      ],
      "default": "banner_first"
    },
    {
      "type": "header",
      "content": "Header Content"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#f5f5f5"
    },
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image"
    },
    {
      "type": "range",
      "id": "overlay_opacity",
      "label": "Dark Overlay Opacity",
      "min": 0,
      "max": 80,
      "step": 5,
      "unit": "%",
      "default": 0,
      "info": "Add a dark overlay on top of the background image to improve text readability"
    },
    {
      "type": "text",
      "id": "header_button_text",
      "label": "Header Button Text",
      "default": "Läs mer"
    },
    {
      "type": "url",
      "id": "header_button_url",
      "label": "Header Button URL"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Smarta elbilsladdare för alla behov"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Våra elbilsladdare är designade för att vara enkel att använda och installera, med hög effekt och snabb laddning."
    },
    {
      "type": "text",
      "id": "primary_button_text",
      "label": "Primary Button Text",
      "default": "Privat"
    },
    {
      "type": "url",
      "id": "primary_button_url",
      "label": "Primary Button URL"
    },
    {
      "type": "text",
      "id": "secondary_button_text",
      "label": "Secondary Button Text",
      "default": "Företag"
    },
    {
      "type": "url",
      "id": "secondary_button_url",
      "label": "Secondary Button URL"
    }
  ],
  "presets": [
    {
      "name": "Banner med 3 produkter",
      "blocks": [
        {
          "type": "product_card",
          "settings": {
            "title": "Laddbox 1",
            "description": "Lagra din egen solenergi och använd den när elpriserna är som högst."
          }
        },
        {
          "type": "product_card",
          "settings": {
            "title": "Laddbox 2",
            "description": "Perfekt för företag och kommersiell användning."
          }
        },
        {
          "type": "product_card",
          "settings": {
            "title": "Laddbox 3",
            "description": "Avancerad laddning för professionella behov."
          }
        }
      ]
    }
  ]
}
{% endschema %}
