{% liquid
  assign section_id = "header-" | append: section.id
%}

<header
  id='{{ section_id }}'
  class='header-section fixed w-full z-50 transition-all duration-300'
  data-header
>
  <!-- Top bar -->
  <div class='header-topbar bg-[#F3F1E8] px-[50px] w-full py-[15px]'>
    <div class='flex text text-[#171717] text-[16px] flex-row gap-[15px] px-[50px]'>
      <div>{{ "general.privatperson" | t | default: "Privatperson" }}</div>
      <div>{{ "general.foretag" | t | default: "Företag" }}</div>
    </div>
  </div>

  <!-- Main header -->
  <div class='header-main py-[15px] w-full header-gradient'>
    <div class='layout w-full flex flex-row justify-between items-center'>
      <!-- Logo -->
      <div class='header-logo'>
        <img
          src='{{ 'logga-vit.svg' | asset_url }}'
          alt='{{ shop.name }}'
          width='auto'
          height='53'
          class='logo-white w-auto h-[53px] transition-opacity duration-300'
        >
        <img
          src='{{ 'logga.svg' | asset_url }}'
          alt='{{ shop.name }}'
          width='auto'
          height='53'
          class='logo-dark w-auto h-[53px] transition-opacity duration-300 opacity-0 absolute top-0 left-0'
        >
      </div>

      <!-- Navigation -->
      <nav class='header-nav flex text-white flex-row gap-[50px]'>
        {% for link in section.settings.menu.links %}
          {% liquid
            case forloop.index
              when 1
                assign has_dropdown = section.settings.nav_item_1_dropdown
                assign dropdown_link_1_title = section.settings.nav_item_1_dropdown_link_1_title
                assign dropdown_link_1_url = section.settings.nav_item_1_dropdown_link_1_url
                assign dropdown_link_2_title = section.settings.nav_item_1_dropdown_link_2_title
                assign dropdown_link_2_url = section.settings.nav_item_1_dropdown_link_2_url
                assign dropdown_link_3_title = ""
                assign dropdown_link_3_url = ""
                assign dropdown_link_4_title = ""
                assign dropdown_link_4_url = ""
              when 2
                assign has_dropdown = section.settings.nav_item_2_dropdown
                assign dropdown_link_1_title = section.settings.nav_item_2_dropdown_link_1_title
                assign dropdown_link_1_url = section.settings.nav_item_2_dropdown_link_1_url
                assign dropdown_link_2_title = section.settings.nav_item_2_dropdown_link_2_title
                assign dropdown_link_2_url = section.settings.nav_item_2_dropdown_link_2_url
                assign dropdown_link_3_title = ""
                assign dropdown_link_3_url = ""
                assign dropdown_link_4_title = ""
                assign dropdown_link_4_url = ""
              when 3
                assign has_dropdown = section.settings.nav_item_3_dropdown
                assign dropdown_link_1_title = section.settings.nav_item_3_dropdown_link_1_title
                assign dropdown_link_1_url = section.settings.nav_item_3_dropdown_link_1_url
                assign dropdown_link_2_title = section.settings.nav_item_3_dropdown_link_2_title
                assign dropdown_link_2_url = section.settings.nav_item_3_dropdown_link_2_url
                assign dropdown_link_3_title = section.settings.nav_item_3_dropdown_link_3_title
                assign dropdown_link_3_url = section.settings.nav_item_3_dropdown_link_3_url
                assign dropdown_link_4_title = section.settings.nav_item_3_dropdown_link_4_title
                assign dropdown_link_4_url = section.settings.nav_item_3_dropdown_link_4_url
              when 4
                assign has_dropdown = section.settings.nav_item_4_dropdown
                assign dropdown_link_1_title = section.settings.nav_item_4_dropdown_link_1_title
                assign dropdown_link_1_url = section.settings.nav_item_4_dropdown_link_1_url
                assign dropdown_link_2_title = section.settings.nav_item_4_dropdown_link_2_title
                assign dropdown_link_2_url = section.settings.nav_item_4_dropdown_link_2_url
                assign dropdown_link_3_title = ""
                assign dropdown_link_3_url = ""
                assign dropdown_link_4_title = ""
                assign dropdown_link_4_url = ""
              else
                assign has_dropdown = false
            endcase
          %}

          {% if has_dropdown %}
            <div class='nav-item dropdown-item relative'>
              <button
                class='bg-transparent nav-link header-text flex flex-row gap-[10px] items-center hover:opacity-80 transition-opacity'
                data-dropdown-toggle
              >
                {{ link.title }}
                <img
                  src='{{ 'dropdown.svg' | asset_url }}'
                  alt='Dropdown'
                  width='8'
                  height='14'
                  class='dropdown-icon w-[8px] h-[14px] transition-transform duration-200'
                >
              </button>

              <!-- Dropdown menu -->
              <div class='dropdown-menu absolute top-full left-0 mt-2 bg-white rounded-lg shadow-lg py-2 text min-w-[200px] opacity-0 invisible transform translate-y-2 transition-all duration-200'>
                {% if dropdown_link_1_title != blank
                  and dropdown_link_1_url != blank
                %}
                  <a
                    href='{{ dropdown_link_1_url }}'
                    class='dropdown-link  block px-4 py-2 text-[#171717] hover:bg-gray-100 transition-colors'
                  >
                    {{ dropdown_link_1_title }}
                  </a>
                {% endif %}
                {% if dropdown_link_2_title != blank
                  and dropdown_link_2_url != blank
                %}
                  <a
                    href='{{ dropdown_link_2_url }}'
                    class='dropdown-link block px-4 py-2 text-[#171717] hover:bg-gray-100 transition-colors'
                  >
                    {{ dropdown_link_2_title }}
                  </a>
                {% endif %}
                {% if dropdown_link_3_title != blank
                  and dropdown_link_3_url != blank
                %}
                  <a
                    href='{{ dropdown_link_3_url }}'
                    class='dropdown-link block px-4 py-2 text-[#171717] hover:bg-gray-100 transition-colors'
                  >
                    {{ dropdown_link_3_title }}
                  </a>
                {% endif %}
                {% if dropdown_link_4_title != blank
                  and dropdown_link_4_url != blank
                %}
                  <a
                    href='{{ dropdown_link_4_url }}'
                    class='dropdown-link block px-4 py-2 text-[#171717] hover:bg-gray-100 transition-colors'
                  >
                    {{ dropdown_link_4_title }}
                  </a>
                {% endif %}
              </div>
            </div>
          {% else %}
            <a
              href='{{ link.url }}'
              class='nav-link header-text hover:opacity-80 transition-opacity'
            >
              {{ link.title }}
            </a>
          {% endif %}
        {% endfor %}
      </nav>

      <!-- Cart button -->
      <button
        class='cart-btn flex flex-row gap-[20px] bg-white knappetikett text-[#171717] p-[20px] py-[15px] rounded-[10px] hover:bg-gray-100 transition-colors relative'
        data-cart-toggle
      >
        kundvagn
        <svg
          xmlns='http://www.w3.org/2000/svg'
          width='21'
          height='22'
          viewBox='0 0 21 22'
          fill='none'
        >
          <path d="M2.37325 16.02L1.16926 8.84C0.98726 7.754 0.896261 7.212 1.18826 6.856C1.47926 6.5 2.01525 6.5 3.08624 6.5H17.9141C18.9851 6.5 19.5211 6.5 19.8121 6.856C20.1041 7.212 20.0121 7.754 19.8311 8.84L18.6271 16.02C18.2281 18.4 18.0291 19.589 17.2141 20.295C16.4001 21 15.2261 21 12.8782 21H8.12219C5.77422 21 4.60023 21 3.78623 20.294C2.97124 19.589 2.77224 18.399 2.37325 16.019M16.0001 6.5C16.0001 5.04131 15.4207 3.64236 14.3892 2.61091C13.3578 1.57946 11.9588 1 10.5002 1C9.0415 1 7.64256 1.57946 6.61112 2.61091C5.57968 3.64236 5.00022 5.04131 5.00022 6.5" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <!-- Cart count badge -->
        <span
          class='cart-count absolute -top-2 -right-2 bg-[#171717] text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold opacity-0 scale-0 transition-all duration-200'
          data-cart-count
        >
          0
        </span>
      </button>
    </div>
  </div>
</header>

<!-- Include Cart Drawer -->
{% render 'cart-drawer' %}


{% stylesheet %}
  .header-section {
    --header-text-color: white;
    --header-bg: linear-gradient(0deg, rgba(23, 23, 23, 0) 0%, #171717 100%);
    --logo-white-opacity: 1;
    --logo-dark-opacity: 0;
  }

  .header-section.scrolled {
    --header-text-color: #171717;
    --header-bg: white;
    --logo-white-opacity: 0;
    --logo-dark-opacity: 1;
  }

  .header-gradient {
    background: var(--header-bg);
  }

  .header-nav {
    color: var(--header-text-color);
  }

  .header-text {
    color: var(--header-text-color) !important;
  }

  .logo-white {
    opacity: var(--logo-white-opacity);
  }

  .logo-dark {
    opacity: var(--logo-dark-opacity);
  }

  .header-logo {
    position: relative;
  }

  /* Dropdown styles */
  .dropdown-item:hover .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-item:hover .dropdown-icon {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    z-index: 1000;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }

  .dropdown-link:hover {
    background-color: #f3f4f6;
  }

  .cart-count.show {
    opacity: 1;
    scale: 1;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .header-topbar {
      padding-left: 20px;
      padding-right: 20px;
    }

    .header-topbar .flex {
      padding-left: 20px;
      padding-right: 20px;
    }

    .header-nav {
      gap: 25px;
      font-size: 14px;
    }

    .layout {
      padding-left: 20px;
      padding-right: 20px;
    }
  }

  @media (max-width: 640px) {
    .header-nav {
      display: none;
    }

    .cart-btn {
      padding: 15px;
      gap: 15px;
    }


  }
{% endstylesheet %}

{% javascript %}
  document.addEventListener('DOMContentLoaded', function () {
    const header = document.querySelector('[data-header]');
    let lastScrollY = window.scrollY;

    function handleScroll() {
      const currentScrollY = window.scrollY;

      // Add scrolled class when user scrolls down
      if (currentScrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }

      lastScrollY = currentScrollY;
    }

    // Throttle scroll events for performance
    let ticking = false;
    function requestTick() {
      if (!ticking) {
        requestAnimationFrame(handleScroll);
        ticking = true;
        setTimeout(() => {
          ticking = false;
        }, 10);
      }
    }

    window.addEventListener('scroll', requestTick);

    // Handle dropdown interactions
    const dropdownItems = document.querySelectorAll('.dropdown-item');

    dropdownItems.forEach((item) => {
      const button = item.querySelector('[data-dropdown-toggle]');
      const menu = item.querySelector('.dropdown-menu');

      // Handle keyboard navigation
      button.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          item.classList.toggle('active');
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', function (e) {
        if (!item.contains(e.target)) {
          item.classList.remove('active');
        }
      });
    });

    // Cart functionality
    const cartToggle = document.querySelector('[data-cart-toggle]');
    const cartDrawer = document.querySelector('[data-cart-drawer]');
    const cartOverlay = document.querySelector('[data-cart-overlay]');
    const cartClose = document.querySelector('[data-cart-close]');
    const cartCount = document.querySelector('[data-cart-count]');
    const cartTotal = document.querySelector('[data-cart-total]');
    const cartEmpty = document.querySelector('[data-cart-empty]');
    const cartItemsList = document.querySelector('[data-cart-items-list]');

    // Debug: Check if elements are found
    console.log('Cart elements found:', {
      cartToggle: !!cartToggle,
      cartDrawer: !!cartDrawer,
      cartOverlay: !!cartOverlay,
      cartClose: !!cartClose,
    });

    // Open cart drawer
    function openCart() {
      console.log('Opening cart drawer');
      if (cartDrawer) {
        console.log('Adding open class to cart drawer');
        cartDrawer.classList.add('open');
        console.log('Cart drawer classes:', cartDrawer.className);
      }
      if (cartOverlay) {
        cartOverlay.classList.add('active');
      }
      document.body.style.overflow = 'hidden';
      loadCartData();
    }

    // Close cart drawer
    function closeCart() {
      cartDrawer.classList.remove('open');
      cartOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }

    // Load cart data from Shopify
    async function loadCartData() {
      try {
        const response = await fetch('/cart.js');
        const cart = await response.json();
        updateCartUI(cart);
      } catch (error) {
        console.error('Error loading cart:', error);
      }
    }

    // Update cart UI
    function updateCartUI(cart) {
      // Update cart count
      const itemCount = cart.item_count;
      cartCount.textContent = itemCount;

      if (itemCount > 0) {
        cartCount.classList.add('show');
        cartEmpty.style.display = 'none';
        cartItemsList.style.display = 'block';
      } else {
        cartCount.classList.remove('show');
        cartEmpty.style.display = 'block';
        cartItemsList.style.display = 'none';
      }

      // Update total
      cartTotal.textContent = formatMoney(cart.total_price);

      // Update items list
      cartItemsList.innerHTML = cart.items
        .map((item) => createCartItemHTML(item))
        .join('');

      // Add event listeners to quantity buttons
      addQuantityListeners();
    }

    // Create cart item HTML
    function createCartItemHTML(item) {
      return `
         <div class="cart-item" data-key="${item.key}">
           <img src="${item.image}" alt="${item.title}" class="cart-item-image" width="70" height="70">
           <div class="cart-item-details">
             <div class="cart-item-header">
               <div class="cart-item-title">${item.product_title}</div>
               <div class="cart-item-price">${formatMoney(item.final_line_price)}</div>
             </div>
             ${item.variant_title ? `<div class="cart-item-variant">${item.variant_title}</div>` : ''}
             <div class="cart-item-controls">
               <div class="cart-item-quantity">
                 <button class="quantity-btn" data-action="decrease" data-key="${item.key}">−</button>
                 <input type="number" class="quantity-input" value="${item.quantity}" min="1" data-key="${item.key}">
                 <button class="quantity-btn" data-action="increase" data-key="${item.key}">+</button>
               </div>
               <button class="cart-item-remove" data-key="${item.key}">Ta bort</button>
             </div>
           </div>
         </div>
       `;
    }

    // Add quantity change listeners
    function addQuantityListeners() {
      const quantityBtns = cartItemsList.querySelectorAll('.quantity-btn');
      const quantityInputs = cartItemsList.querySelectorAll('.quantity-input');
      const removeBtns = cartItemsList.querySelectorAll('.cart-item-remove');

      quantityBtns.forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          const key = e.target.dataset.key;
          const action = e.target.dataset.action;
          const input = cartItemsList.querySelector(`input[data-key="${key}"]`);
          let quantity = parseInt(input.value);

          if (action === 'increase') {
            quantity++;
          } else if (action === 'decrease' && quantity > 1) {
            quantity--;
          }

          await updateCartItem(key, quantity);
        });
      });

      quantityInputs.forEach((input) => {
        input.addEventListener('change', async (e) => {
          const key = e.target.dataset.key;
          const quantity = Math.max(1, parseInt(e.target.value));
          await updateCartItem(key, quantity);
        });
      });

      removeBtns.forEach((btn) => {
        btn.addEventListener('click', async (e) => {
          const key = e.target.dataset.key;
          await updateCartItem(key, 0);
        });
      });
    }

    // Update cart item quantity
    async function updateCartItem(key, quantity) {
      try {
        const response = await fetch('/cart/change.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            id: key,
            quantity: quantity,
          }),
        });

        const cart = await response.json();
        updateCartUI(cart);
      } catch (error) {
        console.error('Error updating cart:', error);
      }
    }

    // Format money
    function formatMoney(cents) {
      return (cents / 100).toLocaleString('sv-SE', {
        style: 'currency',
        currency: 'SEK',
      });
    }

    // Event listeners
    if (cartToggle) {
      cartToggle.addEventListener('click', function (e) {
        e.preventDefault();
        console.log('Cart button clicked');
        openCart();
      });
    }

    if (cartClose) {
      cartClose.addEventListener('click', closeCart);
    }

    if (cartOverlay) {
      cartOverlay.addEventListener('click', closeCart);
    }

    // Close cart with escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape' && cartDrawer.classList.contains('open')) {
        closeCart();
      }
    });

    // Load initial cart data
    loadCartData();
  });
{% endjavascript %}

{% schema %}
{
  "name": "t:sections.header.name",
  "tag": "header",
  "class": "header-section",
  "settings": [
    {
      "type": "header",
      "content": "t:sections.header.settings.navigation.header"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "t:sections.header.settings.menu.label",
      "info": "t:sections.header.settings.menu.info"
    },
    {
      "type": "header",
      "content": "t:sections.header.settings.dropdown_config.header"
    },
    {
      "type": "paragraph",
      "content": "t:sections.header.settings.dropdown_config.info"
    },
    {
      "type": "checkbox",
      "id": "nav_item_1_dropdown",
      "label": "t:sections.header.settings.nav_item_1_dropdown.label",
      "default": false
    },
    {
      "type": "text",
      "id": "nav_item_1_dropdown_link_1_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "visible_if": "{{ section.settings.nav_item_1_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_1_dropdown_link_1_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_1_dropdown }}"
    },
    {
      "type": "text",
      "id": "nav_item_1_dropdown_link_2_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "visible_if": "{{ section.settings.nav_item_1_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_1_dropdown_link_2_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_1_dropdown }}"
    },
    {
      "type": "checkbox",
      "id": "nav_item_2_dropdown",
      "label": "t:sections.header.settings.nav_item_2_dropdown.label",
      "default": false
    },
    {
      "type": "text",
      "id": "nav_item_2_dropdown_link_1_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "visible_if": "{{ section.settings.nav_item_2_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_2_dropdown_link_1_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_2_dropdown }}"
    },
    {
      "type": "text",
      "id": "nav_item_2_dropdown_link_2_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "visible_if": "{{ section.settings.nav_item_2_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_2_dropdown_link_2_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_2_dropdown }}"
    },
    {
      "type": "checkbox",
      "id": "nav_item_3_dropdown",
      "label": "t:sections.header.settings.nav_item_3_dropdown.label",
      "default": true
    },
    {
      "type": "text",
      "id": "nav_item_3_dropdown_link_1_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "default": "Solceller",
      "visible_if": "{{ section.settings.nav_item_3_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_3_dropdown_link_1_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_3_dropdown }}"
    },
    {
      "type": "text",
      "id": "nav_item_3_dropdown_link_2_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "default": "Batterilösningar",
      "visible_if": "{{ section.settings.nav_item_3_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_3_dropdown_link_2_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_3_dropdown }}"
    },
    {
      "type": "text",
      "id": "nav_item_3_dropdown_link_3_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "default": "Värmepumpar",
      "visible_if": "{{ section.settings.nav_item_3_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_3_dropdown_link_3_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_3_dropdown }}"
    },
    {
      "type": "text",
      "id": "nav_item_3_dropdown_link_4_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "default": "Laddboxar",
      "visible_if": "{{ section.settings.nav_item_3_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_3_dropdown_link_4_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_3_dropdown }}"
    },
    {
      "type": "checkbox",
      "id": "nav_item_4_dropdown",
      "label": "t:sections.header.settings.nav_item_4_dropdown.label",
      "default": true
    },
    {
      "type": "text",
      "id": "nav_item_4_dropdown_link_1_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "default": "FAQ",
      "visible_if": "{{ section.settings.nav_item_4_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_4_dropdown_link_1_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_4_dropdown }}"
    },
    {
      "type": "text",
      "id": "nav_item_4_dropdown_link_2_title",
      "label": "t:sections.header.settings.dropdown_link_title",
      "default": "Kontakt",
      "visible_if": "{{ section.settings.nav_item_4_dropdown }}"
    },
    {
      "type": "url",
      "id": "nav_item_4_dropdown_link_2_url",
      "label": "t:sections.header.settings.dropdown_link_url",
      "visible_if": "{{ section.settings.nav_item_4_dropdown }}"
    }
  ]
}
{% endschema %}
