{% liquid
  assign section_id = "header-" | append: section.id
%}

<header
  id='{{ section_id }}'
  class='header-section fixed w-full z-[100] transition-all duration-300'
  data-header
>
  <!-- Top bar -->
  <div class='header-topbar bg-[#F3F1E8] px-[50px] w-full py-[15px]'>
    <div class='flex text text-[#171717] text-[16px] flex-row gap-[15px] px-[50px]'>
      <div>{{ "general.privatperson" | t | default: "Privatperson" }}</div>
      <div>{{ "general.foretag" | t | default: "FÃ¶retag" }}</div>
    </div>
  </div>

  <!-- Main header -->
  <div class='header-main py-[15px] w-full header-gradient'>
    <div class='layout w-full flex flex-row justify-between items-center'>
      <!-- Logo -->
      <a href='{{ routes.root_url }}' class='header-logo'>
        <img
          src='{{ 'logga-vit.svg' | asset_url }}'
          alt='{{ shop.name }}'
          width='auto'
          height='53'
          class='logo-white w-auto h-[53px] transition-opacity duration-300'
        >
        <img
          src='{{ 'logga.svg' | asset_url }}'
          alt='{{ shop.name }}'
          width='auto'
          height='53'
          class='logo-dark w-auto h-[53px] transition-opacity duration-300 opacity-0 absolute top-0 left-0'
        >
      </a>

      <!-- Navigation -->
      <nav class='header-nav flex text-white flex-row gap-[50px]'>
        {% for link in section.settings.menu.links %}
          {% liquid
            assign has_dropdown = false
            assign dropdown_image = blank

            if link.links.size > 0
              assign has_dropdown = true
              case forloop.index
                when 1
                  assign dropdown_image = section.settings.nav_item_1_dropdown_image
                when 2
                  assign dropdown_image = section.settings.nav_item_2_dropdown_image
                when 3
                  assign dropdown_image = section.settings.nav_item_3_dropdown_image
                when 4
                  assign dropdown_image = section.settings.nav_item_4_dropdown_image
              endcase
            endif
          %}

          {% if has_dropdown %}
            <div class='nav-item  dropdown-item relative'>
              <a
                href='{{ link.url }}'
                class='nav-link header-text hover:opacity-80 transition-opacity'
              >
                {{ link.title }}
              </a>

              <!-- Custom Dropdown -->
              <div class='mega-dropdown fixed top-[120px] right-0 left-0 w-screen opacity-0 invisible transition-all duration-300 z-50 layout mx-auto'>
                <div class='py-[40px] px-[50px] rounded-[15px] grid gap-[30px] grid-cols-2 bg-white w-full '>
                  <!-- Left Column - Categories -->
                  <div class='flex flex-col'>
                    <div class='headline1 text-[50px] text-[#171717] pb-[40px]'>
                      {{ link.title }}
                    </div>
                    <div class='flex flex-col gap-[10px]'>
                      {% for child_link in link.links %}
                        <a
                          href='{{ child_link.url }}'
                          class='dropdown-category flex flex-row p-[18px] rounded-[15px] justify-between text-[24px] headline1 bg-[#F3F1E8] hover:bg-[#e8e6dd] transition-colors text-[#171717] w-full'
                        >
                          {{ child_link.title }}
                          <div>
                            <svg
                              xmlns='http://www.w3.org/2000/svg'
                              width='23'
                              height='18'
                              viewBox='0 0 23 18'
                              fill='none'
                            >
                              <path d="M1.55554 9H22L14 1" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                              <path d="M1.55554 8.99994H22L14 16.9999" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                          </div>
                        </a>
                      {% endfor %}
                    </div>
                  </div>

                  <!-- Right Column - Image -->
                  <div class='flex items-center justify-center'>
                    {% if dropdown_image != blank %}
                      <img
                        src='{{ dropdown_image | image_url: width: 1200 }}'
                        alt='{{ link.title }}'
                        width='1920'
                        height='1080'
                        class='dropdown-image h-full w-full rounded-[10px]'
                        loading='lazy'
                      >
                    {% else %}

                    {% endif %}
                  </div>
                </div>
              </div>
            </div>
          {% else %}
            <a
              href='{{ link.url }}'
              class='nav-link header-text hover:opacity-80 transition-opacity'
            >
              {{ link.title }}
            </a>
          {% endif %}
        {% endfor %}
      </nav>

      <!-- Cart button -->
      <button
        class='cart-btn flex flex-row gap-[20px] bg-white knappetikett text-[#171717] p-[20px] py-[15px] rounded-[10px] hover:bg-gray-100 transition-colors relative'
        data-cart-toggle
      >
        kundvagn
        <svg
          xmlns='http://www.w3.org/2000/svg'
          width='21'
          height='22'
          viewBox='0 0 21 22'
          fill='none'
        >
          <path d="M2.37325 16.02L1.16926 8.84C0.98726 7.754 0.896261 7.212 1.18826 6.856C1.47926 6.5 2.01525 6.5 3.08624 6.5H17.9141C18.9851 6.5 19.5211 6.5 19.8121 6.856C20.1041 7.212 20.0121 7.754 19.8311 8.84L18.6271 16.02C18.2281 18.4 18.0291 19.589 17.2141 20.295C16.4001 21 15.2261 21 12.8782 21H8.12219C5.77422 21 4.60023 21 3.78623 20.294C2.97124 19.589 2.77224 18.399 2.37325 16.019M16.0001 6.5C16.0001 5.04131 15.4207 3.64236 14.3892 2.61091C13.3578 1.57946 11.9588 1 10.5002 1C9.0415 1 7.64256 1.57946 6.61112 2.61091C5.57968 3.64236 5.00022 5.04131 5.00022 6.5" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <!-- Cart count badge -->
        <span
          class='cart-count absolute -top-2 -right-2 bg-[#171717] text-white text-xs rounded-full w-6 h-6 flex items-center justify-center font-bold opacity-0 scale-0 transition-all duration-200'
          data-cart-count
        >
          0
        </span>
      </button>
    </div>
  </div>
</header>

<!-- Include Cart Drawer -->
{% render "cart-drawer" %}

<!-- Load Cart JavaScript -->
<script src='{{ 'cart.js' | asset_url }}' defer></script>

{% stylesheet %}
  .header-section {
    --header-text-color: white;
    --header-bg: linear-gradient(0deg, rgba(23, 23, 23, 0) 0%, #171717 100%);
    --logo-white-opacity: 1;
    --logo-dark-opacity: 0;
  }

  .header-section.scrolled {
    --header-text-color: #171717;
    --header-bg: white;
    --logo-white-opacity: 0;
    --logo-dark-opacity: 1;
  }

  .header-gradient {
    background: var(--header-bg);
  }

  .header-nav {
    color: var(--header-text-color);
  }

  .header-text {
    color: var(--header-text-color) !important;
  }

  .logo-white {
    opacity: var(--logo-white-opacity);
  }

  .logo-dark {
    opacity: var(--logo-dark-opacity);
  }

  .header-logo {
    position: relative;
  }

  .cart-count.show {
    opacity: 1;
    scale: 1;
  }

  /* Mega Dropdown Styles */
  .dropdown-item:hover .mega-dropdown {
    opacity: 1;
    visibility: visible;
  }

  .dropdown-category:hover {
    /* Remove transform on hover */
  }

  .dropdown-image {
    transition: transform 0.3s ease;
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .header-topbar {
      padding-left: 20px;
      padding-right: 20px;
    }

    .header-topbar .flex {
      padding-left: 20px;
      padding-right: 20px;
    }

    .header-nav {
      gap: 25px;
      font-size: 14px;
    }

    .layout {
      padding-left: 20px;
      padding-right: 20px;
    }
  }

  @media (max-width: 640px) {
    .header-nav {
      display: none;
    }

    .cart-btn {
      padding: 15px;
      gap: 15px;
    }

    .mega-dropdown {
      display: none;
    }
  }
{% endstylesheet %}

{% javascript %}
  document.addEventListener('DOMContentLoaded', function () {
    const header = document.querySelector('[data-header]');
    let lastScrollY = window.scrollY;

    function handleScroll() {
      const currentScrollY = window.scrollY;

      // Add scrolled class when user scrolls down
      if (currentScrollY > 50) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }

      lastScrollY = currentScrollY;
    }

    // Throttle scroll events for performance
    let ticking = false;
    function requestTick() {
      if (!ticking) {
        requestAnimationFrame(handleScroll);
        ticking = true;
        setTimeout(() => {
          ticking = false;
        }, 10);
      }
    }

    window.addEventListener('scroll', requestTick);

    // Enhanced dropdown interactions
    const dropdownItems = document.querySelectorAll('.dropdown-item');

    dropdownItems.forEach((item) => {
      const dropdown = item.querySelector('.mega-dropdown');
      let hoverTimeout;

      // Show dropdown on mouse enter
      item.addEventListener('mouseenter', () => {
        clearTimeout(hoverTimeout);
        dropdown.style.opacity = '1';
        dropdown.style.visibility = 'visible';
        document.body.style.overflow = 'hidden'; // Prevent body scroll
      });

      // Hide dropdown on mouse leave with delay
      item.addEventListener('mouseleave', () => {
        hoverTimeout = setTimeout(() => {
          dropdown.style.opacity = '0';
          dropdown.style.visibility = 'hidden';
          document.body.style.overflow = ''; // Restore body scroll
        }, 200);
      });

      // Keep dropdown open when hovering over it
      dropdown.addEventListener('mouseenter', () => {
        clearTimeout(hoverTimeout);
      });

      dropdown.addEventListener('mouseleave', () => {
        hoverTimeout = setTimeout(() => {
          dropdown.style.opacity = '0';
          dropdown.style.visibility = 'hidden';
          document.body.style.overflow = ''; // Restore body scroll
        }, 200);
      });

      // Close dropdown when clicking on backdrop
      dropdown.addEventListener('click', (e) => {
        if (e.target === dropdown) {
          dropdown.style.opacity = '0';
          dropdown.style.visibility = 'hidden';
          document.body.style.overflow = '';
        }
      });
    });
  });
{% endjavascript %}

{% schema %}
{
  "name": "sections.header.name",
  "tag": "header",
  "class": "header-section",
  "settings": [
    {
      "type": "header",
      "content": "sections.header.settings.navigation.header"
    },
    {
      "type": "link_list",
      "id": "menu",
      "label": "sections.header.settings.menu.label",
      "info": "sections.header.settings.menu.info"
    },
    {
      "type": "header",
      "content": "Mega Dropdown Images"
    },
    {
      "type": "paragraph",
      "content": "Add images for dropdown menus. Dropdowns automatically appear for menu items that have sub-items configured in Navigation settings."
    },
    {
      "type": "image_picker",
      "id": "nav_item_1_dropdown_image",
      "label": "First nav item dropdown image"
    },
    {
      "type": "image_picker",
      "id": "nav_item_2_dropdown_image",
      "label": "Second nav item dropdown image"
    },
    {
      "type": "image_picker",
      "id": "nav_item_3_dropdown_image",
      "label": "Third nav item dropdown image"
    },
    {
      "type": "image_picker",
      "id": "nav_item_4_dropdown_image",
      "label": "Fourth nav item dropdown image"
    }
  ]
}
{% endschema %}
