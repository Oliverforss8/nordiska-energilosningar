{% liquid
  assign section_id = section.settings.custom_id | default: section.id
  assign section_class = 'section-' | append: section.type

  # Get exactly 3 products using a simple slice method
  assign all_products = collections.all.products

  # Create a string of handles, then convert back to products
  assign product_handles = ''
  assign count = 0

  for prod in all_products
    if count < 3
      if count == 0
        assign product_handles = prod.handle
      else
        assign product_handles = product_handles | append: ',' | append: prod.handle
      endif
      assign count = count | plus: 1
    endif
  endfor

  # Now convert handles back to product array
  assign handle_array = product_handles | split: ','
  assign related_products = all_products | where: 'handle', handle_array[0]
  if handle_array.size > 1
    assign product_2 = all_products | where: 'handle', handle_array[1]
    assign related_products = related_products | concat: product_2
  endif
  if handle_array.size > 2
    assign product_3 = all_products | where: 'handle', handle_array[2]
    assign related_products = related_products | concat: product_3
  endif
%}

<section
  id="{{ section_id }}"
  class="{{ section_class }}"
>
  <div class="layout py-[60px] md:py-[85px]">
    {% if section.settings.title != blank %}
      <h2 class="headline1 mb-8">
        {{ section.settings.title | escape }}
      </h2>
    {% endif %}

    {% if related_products.size > 0 %}
      <!-- Mobile carousel container -->
      <div class=" relative md:hidden">
        <div class="carousel-container overflow-hidden">
          <div
            class="carousel-track flex transition-transform duration-500 ease-in-out"
            data-current="0"
          >
            {% for related_product in related_products %}
              <div
                class="product-card flex w-full flex-shrink-0 flex-col-reverse rounded-[10px] p-[30px]"
                style="background: #F3F1E8;"
              >
                <div class="flex flex-col justify-between ">
                  <div class="flex flex-col">
                    <div class="headline1 pt-[30px] text-[36px] text-[#171717]">
                      {{ related_product.title }}
                    </div>
                    {% if related_product.description != blank %}
                      <div class="text line-clamp-2 py-[20px] text-[#171717]/75">
                        {{
                          related_product.description
                          | strip_html
                          | truncatewords: 12
                          | truncate: 68
                        }}
                      </div>
                    {% endif %}
                  </div>
                  <div class="flex shrink-0">
                    <a
                      href="{{ related_product.url }}"
                      class="buy-now-btn knappetikett flex flex-row items-center gap-[20px] rounded-full bg-transparent px-[20px] py-[18px] text-[#171717]"
                      style="background: #E9A600; border: none;"
                    >
                      Köp nu
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="22"
                        height="18"
                        viewBox="0 0 22 18"
                        fill="none"
                      >
                        <path d="M1 8.99991H21L13.1739 1.17383" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M1 8.9996H21L13.1739 16.8257" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </a>
                  </div>
                </div>
                <div
                  class=" "
                  style="
                        aspect-ratio: 18/23;
                    height: 285.081px;
                  "
                >
                  {% if related_product.featured_image %}
                    <img
                      src="{{ related_product.featured_image | image_url: width: 300 }}"
                      alt="{{ related_product.featured_image.alt | default: related_product.title }}"
                      width="200"
                      height="200"
                      class=" h-full w-full rounded-[5px] object-contain"
                      loading="lazy"
                    >
                  {% else %}
                    <div class="flex h-[200px] w-[200px] items-center justify-center rounded-[5px] bg-gray-200 text-gray-500">
                      {{ 'products.product.media.load_image' | t | default: 'Load image' }}
                    </div>
                  {% endif %}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Desktop grid -->
      <div class=" hidden grid-cols-3  gap-[20px] md:grid">
        {% for related_product in related_products %}
          <div
            class="product-card flex flex-col-reverse rounded-[10px]  p-[30px] transition-colors duration-300"
          >
            <div class="flex flex-col justify-between ">
              <div class="flex flex-col">
                <div class="headline1 pt-[40px] text-[36px] text-[#171717] xl:pt-0">
                  {{ related_product.title }}
                </div>
                {% if related_product.description != blank %}
                  <div class="text line-clamp-2 py-[20px] text-[#171717]/75 xl:pt-[40px]">
                    {{
                      related_product.description
                      | strip_html
                      | truncatewords: 12
                      | truncate: 68
                    }}
                  </div>
                {% endif %}
              </div>
              <div class="flex shrink-0">
                <a
                  href="{{ related_product.url }}"
                  class="buy-now-btn knappetikett flex shrink-0 flex-row items-center gap-[20px] whitespace-nowrap rounded-full bg-transparent px-[20px] py-[18px] text-[#171717]"
                  style="background: #E9A600; border: none;"
                >
                  Köp nu
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="22"
                    height="18"
                    viewBox="0 0 22 18"
                    fill="none"
                  >
                    <path d="M1 8.99991H21L13.1739 1.17383" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M1 8.9996H21L13.1739 16.8257" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </a>
              </div>
            </div>
            <div
              class=" "
              style="
                    aspect-ratio: 18/23;
                height: 285.081px;
              "
            >
              {% if related_product.featured_image %}
                <img
                  src="{{ related_product.featured_image | image_url: width: 300 }}"
                  alt="{{ related_product.featured_image.alt | default: related_product.title }}"
                  width="200"
                  height="200"
                  class=" h-full w-full rounded-[5px] object-contain"
                  loading="lazy"
                >
              {% else %}
                <div class="flex h-full w-[200px] items-center justify-center rounded-[5px] bg-gray-200 text-gray-500">
                  {{ 'products.product.media.load_image' | t | default: 'Load image' }}
                </div>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>

      <!-- Carousel navigation (only show on mobile) -->
      <div class="flex flex-row gap-[20px] pl-[20px] pt-[20px] md:hidden">
        <button
          type="button"
          class="carousel-prev flex h-[48px] w-[48px] items-center justify-center rounded-full transition-all active:scale-95"
          aria-label="Föregående produkt"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="26"
            height="21"
            viewBox="0 0 26 21"
            fill="none"
          >
            <path d="M25 10.3915H1M1 10.3915L10.3913 1M1 10.3915L10.3913 19.7826" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button
          type="button"
          class="carousel-next flex h-[48px] w-[48px] items-center justify-center rounded-full transition-all active:scale-95"
          aria-label="Nästa produkt"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="26"
            height="21"
            viewBox="0 0 26 21"
            fill="none"
          >
            <path d="M1 10.3915H25M25 10.3915L15.6087 1M25 10.3915L15.6087 19.7826" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    {% else %}
      <div class="py-8 text-center text-gray-500">
        {{ section.settings.no_products_message | default: 'Inga relaterade produkter hittades.' }}
      </div>
    {% endif %}
  </div>
</section>

{% stylesheet %}
  .section-relaterade-produkter a,
  .section-related-products a {
    text-decoration: none;
  }

  .section-relaterade-produkter a:hover,
  .section-related-products a:hover {
    text-decoration: none;
  }

  /* Buy now button styling */
  .section-relaterade-produkter .product-card .buy-now-btn {
    background: #e9a600;
    border: none;
    color: #171717;
    transition: all 0.3s ease;
  }

  .section-relaterade-produkter .product-card .buy-now-btn:hover {
    background: #d69500 !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(255, 169, 77, 0.3);
  }

  .section-relaterade-produkter .product-card .buy-now-btn svg path {
    stroke: #171717 !important;
  }

  /* Card background transition */
  .section-relaterade-produkter .product-card {
    transition: background-color 0.3s ease;
  }

  .section-relaterade-produkter .carousel-container {
    position: relative;
  }

  .section-relaterade-produkter .carousel-track {
    transition: transform 0.5s ease-in-out;
  }

  .section-relaterade-produkter .carousel-prev,
  .section-relaterade-produkter .carousel-next {
    transition: all 0.2s ease-in-out;
    border: 1px solid #171717;
    outline: none;
    background: transparent;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
    user-select: none;
    -webkit-user-select: none;
  }

  .section-relaterade-produkter .carousel-prev:hover,
  .section-relaterade-produkter .carousel-next:hover {
    background: #f6f6f6;
    transform: scale(1.05);
  }

  .section-relaterade-produkter .carousel-prev:active,
  .section-relaterade-produkter .carousel-next:active {
    background: #e5e5e5;
    transform: scale(0.95);
  }

  .section-relaterade-produkter .carousel-prev:disabled,
  .section-relaterade-produkter .carousel-next:disabled {
    opacity: 0.3;
    cursor: not-allowed;
    transform: none;
  }

  .section-relaterade-produkter .carousel-prev:disabled:hover,
  .section-relaterade-produkter .carousel-next:disabled:hover {
    transform: none;
    background: transparent;
  }

  .section-relaterade-produkter .carousel-prev svg,
  .section-relaterade-produkter .carousel-next svg {
    pointer-events: none;
  }

  /* Line clamp for 2 lines */
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
{% endstylesheet %}

<script>
  (function () {
    'use strict';

    console.log('Related products carousel script loading...');

    function initCarousel() {
      // Try multiple selectors to find the carousel
      const track =
        document.querySelector('.carousel-track') ||
        document.querySelector('[class*="relaterade"] .carousel-track') ||
        document.querySelector('[class*="related"] .carousel-track');

      const prevBtn =
        document.querySelector('.carousel-prev') ||
        document.querySelector('[class*="relaterade"] .carousel-prev') ||
        document.querySelector('[class*="related"] .carousel-prev');

      const nextBtn =
        document.querySelector('.carousel-next') ||
        document.querySelector('[class*="relaterade"] .carousel-next') ||
        document.querySelector('[class*="related"] .carousel-next');

      console.log('Track found:', !!track);
      console.log('Prev button found:', !!prevBtn);
      console.log('Next button found:', !!nextBtn);

      if (!track || !prevBtn || !nextBtn) {
        console.error('Carousel elements not found!');
        return;
      }

      const slides = track.querySelectorAll('.product-card');
      const totalSlides = slides.length;

      console.log('Total slides:', totalSlides);

      if (totalSlides === 0) {
        console.error('No slides found!');
        return;
      }

      let currentIndex = 0;

      function updateCarousel() {
        const offset = -currentIndex * 100;
        track.style.transform = `translateX(${offset}%)`;

        // Update button states
        if (prevBtn) {
          prevBtn.disabled = currentIndex === 0;
          prevBtn.style.opacity = currentIndex === 0 ? '0.3' : '1';
        }

        if (nextBtn) {
          nextBtn.disabled = currentIndex === totalSlides - 1;
          nextBtn.style.opacity = currentIndex === totalSlides - 1 ? '0.3' : '1';
        }

        console.log('Moved to slide:', currentIndex + 1, '/', totalSlides);
      }

      function goToNext(e) {
        if (e) {
          e.preventDefault();
          e.stopPropagation();
        }
        console.log('Next button clicked');

        if (currentIndex < totalSlides - 1) {
          currentIndex++;
          updateCarousel();
        }
      }

      function goToPrev(e) {
        if (e) {
          e.preventDefault();
          e.stopPropagation();
        }
        console.log('Prev button clicked');

        if (currentIndex > 0) {
          currentIndex--;
          updateCarousel();
        }
      }

      // Remove any existing listeners and add new ones
      const newPrevBtn = prevBtn.cloneNode(true);
      const newNextBtn = nextBtn.cloneNode(true);

      prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
      nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);

      newPrevBtn.addEventListener('click', goToPrev, false);
      newNextBtn.addEventListener('click', goToNext, false);

      console.log('Event listeners attached');

      // Touch support
      let touchStartX = 0;
      let touchEndX = 0;

      track.addEventListener(
        'touchstart',
        function (e) {
          touchStartX = e.changedTouches[0].screenX;
        },
        { passive: true }
      );

      track.addEventListener(
        'touchend',
        function (e) {
          touchEndX = e.changedTouches[0].screenX;
          handleSwipe();
        },
        { passive: true }
      );

      function handleSwipe() {
        const swipeThreshold = 50;
        const diff = touchStartX - touchEndX;

        if (Math.abs(diff) > swipeThreshold) {
          if (diff > 0 && currentIndex < totalSlides - 1) {
            currentIndex++;
            updateCarousel();
          } else if (diff < 0 && currentIndex > 0) {
            currentIndex--;
            updateCarousel();
          }
        }
      }

      // Initialize
      updateCarousel();

      console.log('Carousel initialized successfully!');
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initCarousel);
    } else {
      // DOM already loaded
      initCarousel();
    }

    // Also try to initialize after a short delay as backup
    setTimeout(initCarousel, 500);
  })();
</script>

{% schema %}
{
  "name": "Relaterade produkter",
  "tag": "section",
  "class": "section-related-products",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Rubrik",
      "default": "Relaterade produkter"
    },
    {
      "type": "text",
      "id": "no_products_message",
      "label": "Meddelande när inga produkter hittas",
      "default": "Inga relaterade produkter hittades."
    },
    {
      "type": "text",
      "id": "custom_id",
      "label": "Anpassat ID"
    }
  ],
  "presets": [
    {
      "name": "Relaterade produkter"
    }
  ]
}
{% endschema %}
