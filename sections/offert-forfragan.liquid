<section class="layout pt-[150px]">
  <div class="flex flex-col gap-[20px]  lg:flex-row xl:grid xl:grid-cols-2">
    <!-- Form Section -->
    <div class="quote-form-section rounded-[15px] bg-[#F3F1E8] p-[20px] md:p-[50px] lg:w-[64%] xl:w-full xl:flex-shrink-0">
      <div class="flex flex-col">
        <div class="headline1 text-[40px]">
          {{ section.settings.title | default: 'Offert förfrågan' }}
        </div>
        <div class=" body1 py-[30px] text-[20px] opacity-80">
          {{
            section.settings.description
            | default: '<p>Ett solcellssystem med batteri och AI-styrning gör att du inte bara producerar egen el!</p>'
          }}
        </div>
        <form
          class="flex flex-col gap-[15px] md:gap-[20px]"
          id="quote-form"
        >
          {% for block in section.blocks %}
            {% if block.type == 'form_field' %}
              {% liquid
                assign field_type = block.settings.field_type | default: 'text'
                assign field_name = block.settings.name | default: block.settings.label | handleize
                assign is_required = block.settings.required
                assign placeholder = block.settings.placeholder | default: block.settings.label
                assign pattern = block.settings.pattern
                assign rows = block.settings.rows | default: 4
              %}
              {% if field_type == 'textarea' %}
                <textarea
                  class="body1 min-h-[120px] rounded-[10px] bg-white p-[15px] text-[16px] text-[#171717]/85 md:text-[18px]"
                  name="{{ field_name }}"
                  placeholder="{{ placeholder | escape }}"
                  {% if is_required %}
                    required
                  {% endif %}
                  rows="{{ rows }}"
                ></textarea>
              {% else %}
                <input
                  class="body1 h-[45px] rounded-[10px] bg-white pl-[15px] text-[16px] text-[#171717]/85 md:text-[18px]"
                  placeholder="{{ placeholder | escape }}"
                  type="{{ field_type }}"
                  name="{{ field_name }}"
                  {% if is_required %}
                    required
                  {% endif %}
                  {% if pattern != blank %}
                    pattern="{{ pattern }}"
                  {% endif %}
                >
              {% endif %}
            {% endif %}
          {% endfor %}
          <div class="body1 flex flex-col gap-[5px] text-[20px] md:flex-row md:text-[25px]">
            Hur kan vi hjälpa dig?
            <span class="text-[13px] opacity-70 md:text-[15px]">
              Klicka för att välja (flera val möjligt)*
            </span>
          </div>
          <div class="flex flex-row flex-wrap gap-[10px]">
            {% for block in section.blocks %}
              {% if block.type == 'service_option' %}
                {% liquid
                  assign service_key = block.settings.service_key | default: block.settings.label | handleize
                %}
                <button
                  type="button"
                  class="headline1 service-option flex flex-row items-center justify-center gap-[10px] rounded-[10px] bg-white px-[15px] py-[10px] text-[18px] md:text-[20px]"
                  data-service="{{ service_key }}"
                >
                  {% if block.settings.icon_svg != blank %}
                    {{ block.settings.icon_svg }}
                  {% elsif block.settings.icon_image != blank %}
                    <img
                      src="{{ block.settings.icon_image | image_url: width: 40 }}"
                      alt="{{ block.settings.label | escape }}"
                      width="40"
                      height="40"
                    >
                  {% endif %}
                  {{ block.settings.label | default: 'Tjänst' }}
                </button>
              {% endif %}
            {% endfor %}
          </div>

          <!-- Hidden fields with product information -->
          <input
            type="hidden"
            name="selected_service"
            id="selected_service"
          >
          <input
            type="hidden"
            name="product_title"
            value="{{ product.title }}"
          >
          <input
            type="hidden"
            name="product_handle"
            value="{{ product.handle }}"
          >
          <input
            type="hidden"
            name="product_id"
            value="{{ product.id }}"
          >
          <input
            type="hidden"
            name="product_url"
            value="{{ shop.secure_url }}{{ product.url }}"
          >
          <input
            type="hidden"
            name="_subject"
            value="Offert förfrågan för {{ product.title }}"
          >
          <button
            type="submit"
            class="headline1 quote-submit-btn flex w-full flex-row items-center justify-center gap-[15px] rounded-[10px] bg-[#EFD959] py-[14px] text-[18px] md:gap-[20px] md:text-[20px]"
          >
            Få ditt förslag
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="18"
              height="14"
              viewBox="0 0 18 14"
              fill="none"
            >
              <path d="M1.66699 7.00009H16.667L10.7974 1.13049" stroke="#171717" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M1.66699 7.00004H16.667L10.7974 12.8696" stroke="#171717" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
        </form>
      </div>
    </div>

    <!-- Success Section (hidden initially) -->
    <div
      class="quote-success-section relative flex hidden h-full flex-col rounded-[15px] p-[20px] md:p-[50px] lg:w-[64%] xl:w-full xl:flex-shrink-0"
      style="background: #EFD959;"
    >
      <div
        class="absolute inset-0 rounded-[15px]"
        style="background: url({{ "Gradient.png" | asset_url }}) center/cover no-repeat; opacity: 0.5;"
      ></div>
      <div class="relative z-10 flex h-full flex-col justify-between gap-[50px]">
        <div class="flex h-full flex-col">
          <div class="headline1 text-[40px]">Tack för din förfrågan!</div>
          <div class="body1 pt-[30px] text-[20px] opacity-80">
            Vi har mottagit din offertförfrågan och återkommer inom kort med ett skräddarsytt
            förslag.
          </div>
        </div>
        <div class="flex h-full flex-col">
          <div class="headline1 pb-[30px] text-[40px]">Vad händer nu?</div>
          <div class="flex flex-wrap gap-[20px]">
            <button class="headline1 flex flex-row items-center gap-[30px] rounded-[15px] bg-white px-[30px] py-[15px] text-[24px]">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="39"
                height="36"
                viewBox="0 0 39 36"
                fill="none"
              >
                <path opacity="0.8" d="M4.562 26.5831C2 24.5013 2 22.9262 2 16.2222C2 9.51822 2 6.16533 4.562 4.08356C7.1275 2 11.2505 2 19.5 2C27.7495 2 31.8742 2 34.4362 4.08356C36.9982 6.16711 37 9.51822 37 16.2222C37 22.9262 37 24.5013 34.4362 26.5831C31.876 28.6667 27.7495 28.6667 19.5 28.6667C15.1075 28.6667 12.85 31.7564 9 34V28.2898C7.0855 28 5.67675 27.4898 4.562 26.5831Z" stroke="#171717" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Vi kontaktar dig
            </button>
            <button class="headline1 flex flex-row items-center gap-[30px] rounded-[15px] bg-white px-[30px] py-[15px] text-[24px]">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="36"
                height="44"
                viewBox="0 0 36 44"
                fill="none"
              >
                <g opacity="0.8">
                  <path d="M27.05 5H32C32.5304 5 33.0391 5.21071 33.4142 5.58579C33.7893 5.96086 34 6.46957 34 7V40C34 40.5304 33.7893 41.0391 33.4142 41.4142C33.0391 41.7893 32.5304 42 32 42H4C3.46957 42 2.96086 41.7893 2.58579 41.4142C2.21071 41.0391 2 40.5304 2 40V7C2 6.46957 2.21071 5.96086 2.58579 5.58579C2.96086 5.21071 3.46957 5 4 5H11V8H25V5H27.05Z" stroke="#171717" stroke-width="3" stroke-linejoin="round"/>
                  <path d="M21 17L13 25.001H23.004L15 33.001M11 2H25V8H11V2Z" stroke="#171717" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                </g>
              </svg>
              Du får ett anpassat förslag
            </button>
            <button class="headline1 flex flex-row items-center gap-[30px] rounded-[15px] bg-white px-[30px] py-[15px] text-[24px]">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="33"
                height="40"
                viewBox="0 0 33 40"
                fill="none"
              >
                <path opacity="0.8" fill-rule="evenodd" clip-rule="evenodd" d="M16.5 9.74998e-06C13.8653 -0.00351821 11.3181 0.950489 9.32765 2.68626C7.33723 4.42203 6.03772 6.82261 5.66856 9.44571C5.2994 12.0688 5.88545 14.7377 7.31874 16.9606C8.75203 19.1835 10.936 20.8108 13.4682 21.5424C9.86986 21.9818 6.78383 23.2606 4.45726 25.5667C1.49781 28.497 0 32.8636 0 38.5606C0 38.9424 0.150819 39.3085 0.419278 39.5784C0.687738 39.8484 1.05185 40 1.43151 40C1.81117 40 2.17528 39.8484 2.44373 39.5784C2.71219 39.3085 2.86301 38.9424 2.86301 38.5606C2.86301 33.3485 4.22822 29.8333 6.4674 27.6152C8.70959 25.3939 12.0608 24.2424 16.5 24.2424C20.9392 24.2424 24.2904 25.3939 26.5356 27.6152C28.7718 29.8364 30.137 33.3485 30.137 38.5606C30.137 38.9424 30.2878 39.3085 30.5563 39.5784C30.8247 39.8484 31.1888 40 31.5685 40C31.9482 40 32.3123 39.8484 32.5807 39.5784C32.8492 39.3085 33 38.9424 33 38.5606C33 32.8636 31.5022 28.5 28.5397 25.5667C26.2192 23.2636 23.1301 21.9818 19.5318 21.5424C22.0556 20.8025 24.2296 19.1728 25.6554 16.952C27.0812 14.7313 27.6633 12.0682 27.295 9.45089C26.9266 6.83362 25.6326 4.43749 23.6499 2.7017C21.6672 0.965914 19.1289 0.00674768 16.5 9.74998e-06ZM8.43835 10.9849C8.43835 8.835 9.2877 6.77319 10.7996 5.25301C12.3114 3.73283 14.3619 2.8788 16.5 2.8788C18.6381 2.8788 20.6886 3.73283 22.2004 5.25301C23.7123 6.77319 24.5616 8.835 24.5616 10.9849C24.5616 13.1347 23.7123 15.1965 22.2004 16.7167C20.6886 18.2369 18.6381 19.0909 16.5 19.0909C14.3619 19.0909 12.3114 18.2369 10.7996 16.7167C9.2877 15.1965 8.43835 13.1347 8.43835 10.9849Z" fill="#171717"/>
              </svg>
              Sen är beslutet ditt!
            </button>
          </div>
        </div>
      </div>
    </div>
    <div class="flex flex-1 flex-col gap-[10px]">
      <div class="relative h-[200px] overflow-hidden rounded-[15px] lg:h-full">
        <img
          src="{{ section.settings.card_1_image | image_url: width: 600 }}"
          alt="{{ section.settings.card_1_image.alt | escape }}"
          width="600"
          height="300"
          class="absolute inset-0 h-full w-full object-cover"
        >
        {% if section.settings.card_1_overlay_opacity > 0 %}
          <div
            class="absolute inset-0 rounded-[15px]"
            style="background-color: rgba(0, 0, 0, {{ section.settings.card_1_overlay_opacity | divided_by: 100.0 }});"
          ></div>
        {% endif %}
        {% if section.settings.card_1_button_text != blank
          and section.settings.card_1_button_link != blank
        %}
          <a
            href="{{ section.settings.card_1_button_link }}"
            class="absolute inset-0  z-10 flex items-end justify-start p-[20px] no-underline"
          >
            <button class="knappetikett rounded-[10px] bg-[#FFF] px-[20px] py-[15px] text-[15px] text-[#171717] no-underline md:px-[30px] md:py-[18px] md:text-[20px]">
              {{ section.settings.card_1_button_text | escape }}
            </button>
          </a>
        {% endif %}
      </div>

      <div class="relative h-[200px] overflow-hidden rounded-[15px] lg:h-full">
        <img
          src="{{ section.settings.card_2_image | image_url: width: 600 }}"
          alt="{{ section.settings.card_2_image.alt | escape }}"
          width="600"
          height="300"
          class="absolute inset-0 h-full w-full object-cover"
        >
        {% if section.settings.card_2_overlay_opacity > 0 %}
          <div
            class="absolute inset-0 rounded-[15px]"
            style="background-color: rgba(0, 0, 0, {{ section.settings.card_2_overlay_opacity | divided_by: 100.0 }});"
          ></div>
        {% endif %}
        {% if section.settings.card_2_button_text != blank
          and section.settings.card_2_button_link != blank
        %}
          <a
            href="{{ section.settings.card_2_button_link }}"
            class="absolute inset-0  z-10 flex items-end justify-start p-[20px] no-underline"
          >
            <button class="knappetikett rounded-[10px] bg-[#FFF] px-[20px] py-[15px] text-[15px] text-[#171717] no-underline md:px-[30px] md:py-[18px] md:text-[20px]">
              {{ section.settings.card_2_button_text | escape }}
            </button>
          </a>
        {% endif %}
      </div>

      <div class="relative h-[200px] overflow-hidden rounded-[15px] lg:h-full">
        <img
          src="{{ section.settings.card_3_image | image_url: width: 600 }}"
          alt="{{ section.settings.card_3_image.alt | escape }}"
          width="600"
          height="300"
          class="absolute inset-0 h-full w-full object-cover"
        >
        {% if section.settings.card_3_overlay_opacity > 0 %}
          <div
            class="absolute inset-0 rounded-[15px]"
            style="background-color: rgba(0, 0, 0, {{ section.settings.card_3_overlay_opacity | divided_by: 100.0 }});"
          ></div>
        {% endif %}
        {% if section.settings.card_3_button_text != blank
          and section.settings.card_3_button_link != blank
        %}
          <a
            href="{{ section.settings.card_3_button_link }}"
            class="absolute inset-0  z-10 flex items-end justify-start p-[20px] no-underline"
          >
            <button class="knappetikett rounded-[10px] bg-[#FFF] px-[20px] py-[15px] text-[15px] text-[#171717] no-underline md:px-[30px] md:py-[18px] md:text-[20px]">
              {{ section.settings.card_3_button_text | escape }}
            </button>
          </a>
        {% endif %}
      </div>

      <div class="relative h-[200px] overflow-hidden rounded-[15px] lg:h-full">
        <img
          src="{{ section.settings.card_4_image | image_url: width: 600 }}"
          alt="{{ section.settings.card_4_image.alt | escape }}"
          width="600"
          height="300"
          class="absolute inset-0 h-full w-full object-cover"
        >
        {% if section.settings.card_4_overlay_opacity > 0 %}
          <div
            class="absolute inset-0 rounded-[15px]"
            style="background-color: rgba(0, 0, 0, {{ section.settings.card_4_overlay_opacity | divided_by: 100.0 }});"
          ></div>
        {% endif %}
        {% if section.settings.card_4_button_text != blank
          and section.settings.card_4_button_link != blank
        %}
          <a
            href="{{ section.settings.card_4_button_link }}"
            class="absolute inset-0  z-10 flex items-end justify-start p-[20px] no-underline"
          >
            <button class="knappetikett rounded-[10px] bg-[#FFF] px-[20px] py-[15px] text-[15px] text-[#171717] no-underline md:px-[30px] md:py-[18px] md:text-[20px]">
              {{ section.settings.card_4_button_text | escape }}
            </button>
          </a>
        {% endif %}
      </div>
    </div>
  </div>
</section>

{% javascript %}
  // Quote form functionality
  document.addEventListener('DOMContentLoaded', function () {
    console.log('Quote form script loaded in section!');

    const serviceOptions = document.querySelectorAll('.service-option');
    const selectedServiceInput = document.getElementById('selected_service');
    const quoteSubmitBtn = document.querySelector('.quote-submit-btn');

    console.log('Found service options:', serviceOptions.length);

    // Handle service option selection (multiple selection)
    serviceOptions.forEach((option, index) => {
      console.log('Setting up listener for option', index);

      option.addEventListener('click', function (e) {
        e.preventDefault();
        console.log('Button clicked!', this);

        const service = this.getAttribute('data-service');
        const isSelected = this.getAttribute('data-selected') === 'true';

        console.log('Service:', service, 'Is selected:', isSelected);

        if (isSelected) {
          // Deselect this option
          this.style.backgroundColor = 'white';
          this.setAttribute('data-selected', 'false');
          console.log('Deselected:', service);
        } else {
          // Select this option
          this.style.backgroundColor = '#EFD959';
          this.setAttribute('data-selected', 'true');
          console.log('Selected:', service);
        }

        // Update hidden input with all selected services
        const selectedServices = [];
        serviceOptions.forEach((opt) => {
          if (opt.getAttribute('data-selected') === 'true') {
            selectedServices.push(opt.getAttribute('data-service'));
          }
        });

        if (selectedServiceInput) {
          selectedServiceInput.value = selectedServices.join(', ');
        }

        console.log('All selected services:', selectedServices);
      });
    });

    // Handle form submission
    const quoteForm = document.getElementById('quote-form');
    if (quoteForm) {
      quoteForm.addEventListener('submit', async function (e) {
        e.preventDefault();

        // Basic validation
        const selectedService = selectedServiceInput ? selectedServiceInput.value : '';
        if (!this.checkValidity()) {
          this.reportValidity();
          return;
        }

        if (!selectedService || selectedService.trim() === '') {
          alert('Vänligen välj minst en tjänst');
          return;
        }

        const submitBtn = this.querySelector('.quote-submit-btn');

        // Show loading state
        if (submitBtn) {
          const originalText = submitBtn.innerHTML;
          submitBtn.innerHTML = 'Skickar...';
          submitBtn.disabled = true;

          try {
            // Submit to Formspree
            const formData = new FormData(this);

            const response = await fetch('https://formspree.io/f/mdkllzwo', {
              method: 'POST',
              body: formData,
              headers: {
                Accept: 'application/json',
              },
            });

            if (response.ok) {
              // Hide the form section and show the success section
              const formSection = document.querySelector('.quote-form-section');
              const successSection = document.querySelector('.quote-success-section');

              if (formSection && successSection) {
                formSection.style.display = 'none';
                successSection.style.display = 'block';
              } else {
                // Fallback to alert if sections not found
                alert('Tack för din förfrågan! Vi återkommer inom kort.');
              }

              // Reset form
              this.reset();
              if (selectedServiceInput) selectedServiceInput.value = '';

              // Reset service buttons
              serviceOptions.forEach((opt) => {
                opt.style.backgroundColor = 'white';
                opt.setAttribute('data-selected', 'false');
              });
            } else {
              throw new Error('Form submission failed');
            }
          } catch (error) {
            console.error('Error submitting form:', error);
            alert('Det uppstod ett fel när formuläret skickades. Vänligen försök igen.');
          } finally {
            // Reset button
            if (submitBtn) {
              submitBtn.innerHTML = originalText;
              submitBtn.disabled = false;
            }
          }
        }
      });
    }
  });
{% endjavascript %}

{% schema %}
{
  "name": "Offertförfrågan",
  "tag": "section",
  "class": "section-offert-forfragan",
  "max_blocks": 50,
  "blocks": [
    {
      "type": "service_option",
      "name": "Tjänsteval",
      "limit": 12,
      "settings": [
        {
          "type": "text",
          "id": "label",
          "label": "Etikett",
          "default": "Solceller"
        },
        {
          "type": "text",
          "id": "service_key",
          "label": "Nyckel (valfritt)",
          "info": "Används som data-service. Lämna tomt för att använda etiketten."
        },
        {
          "type": "image_picker",
          "id": "icon_image",
          "label": "Ikonbild (valfritt)"
        },
        {
          "type": "html",
          "id": "icon_svg",
          "label": "Inline SVG (valfritt)",
          "info": "Klistra in rå SVG-kod här om du vill använda egen SVG."
        }
      ]
    },
    {
      "type": "form_field",
      "name": "Formulärfält",
      "limit": 30,
      "settings": [
        { "type": "text", "id": "label", "label": "Etikett", "default": "För- & efternamn" },
        {
          "type": "text",
          "id": "name",
          "label": "Fältnamn (valfritt)",
          "info": "Om tomt används etiketten som namn (handleized)"
        },
        {
          "type": "select",
          "id": "field_type",
          "label": "Typ",
          "options": [
            { "value": "text", "label": "Text" },
            { "value": "email", "label": "E‑post" },
            { "value": "tel", "label": "Telefon" },
            { "value": "textarea", "label": "Textarea" }
          ],
          "default": "text"
        },
        { "type": "text", "id": "placeholder", "label": "Platshållare (valfritt)" },
        { "type": "checkbox", "id": "required", "label": "Obligatoriskt", "default": true },
        {
          "type": "text",
          "id": "pattern",
          "label": "HTML5 pattern (valfritt)",
          "info": "RegExp för validering, t.ex.^[0-9\\- +()]*$ för telefon"
        },
        {
          "type": "number",
          "id": "rows",
          "label": "Textarea rader",
          "default": 4,
          "info": "Gäller endast textarea"
        }
      ]
    }
  ],
  "settings": [
    {
      "type": "header",
      "content": "Innehåll"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Rubrik",
      "default": "Begär offert"
    },
    {
      "type": "richtext",
      "id": "description",
      "label": "Beskrivning",
      "default": "<p>Fyll i formuläret nedan så återkommer vi till dig med en skräddarsydd offert.</p>"
    },
    {
      "type": "header",
      "content": "Kort 1"
    },
    {
      "type": "image_picker",
      "id": "card_1_image",
      "label": "Bild 1"
    },
    {
      "type": "text",
      "id": "card_1_button_text",
      "label": "Knapptext 1"
    },
    {
      "type": "url",
      "id": "card_1_button_link",
      "label": "Knapplänk 1"
    },
    {
      "type": "range",
      "id": "card_1_overlay_opacity",
      "label": "Överlagring opacitet 1",
      "min": 0,
      "max": 100,
      "default": 0,
      "unit": "%"
    },
    {
      "type": "header",
      "content": "Kort 2"
    },
    {
      "type": "image_picker",
      "id": "card_2_image",
      "label": "Bild 2"
    },
    {
      "type": "text",
      "id": "card_2_button_text",
      "label": "Knapptext 2"
    },
    {
      "type": "url",
      "id": "card_2_button_link",
      "label": "Knapplänk 2"
    },
    {
      "type": "range",
      "id": "card_2_overlay_opacity",
      "label": "Överlagring opacitet 2",
      "min": 0,
      "max": 100,
      "default": 0,
      "unit": "%"
    },
    {
      "type": "header",
      "content": "Kort 3"
    },
    {
      "type": "image_picker",
      "id": "card_3_image",
      "label": "Bild 3"
    },
    {
      "type": "text",
      "id": "card_3_button_text",
      "label": "Knapptext 3"
    },
    {
      "type": "url",
      "id": "card_3_button_link",
      "label": "Knapplänk 3"
    },
    {
      "type": "range",
      "id": "card_3_overlay_opacity",
      "label": "Överlagring opacitet 3",
      "min": 0,
      "max": 100,
      "default": 0,
      "unit": "%"
    },
    {
      "type": "header",
      "content": "Kort 4"
    },
    {
      "type": "image_picker",
      "id": "card_4_image",
      "label": "Bild 4"
    },
    {
      "type": "text",
      "id": "card_4_button_text",
      "label": "Knapptext 4"
    },
    {
      "type": "url",
      "id": "card_4_button_link",
      "label": "Knapplänk 4"
    },
    {
      "type": "range",
      "id": "card_4_overlay_opacity",
      "label": "Överlagring opacitet 4",
      "min": 0,
      "max": 100,
      "default": 0,
      "unit": "%"
    }
  ],
  "presets": [
    {
      "name": "Offertförfrågan",
      "blocks": [
        {
          "type": "form_field",
          "settings": { "label": "För- & efternamn", "field_type": "text", "required": true }
        },
        {
          "type": "form_field",
          "settings": { "label": "E‑postadress", "field_type": "email", "required": true }
        },
        {
          "type": "form_field",
          "settings": {
            "label": "Telefonnummer",
            "field_type": "tel",
            "required": false,
            "pattern": "^[0-9\\- +()]*$"
          }
        },
        {
          "type": "form_field",
          "settings": { "label": "Adress", "field_type": "text", "required": false }
        }
      ]
    }
  ]
}
{% endschema %}
