{% liquid
  assign section_class = 'section-' | append: section.type
%}

<article
  class="{{ section_class }} layout grid grid-cols-1  pt-[150px] md:grid-cols-3 md:gap-[50px]"
  style="
    --section-padding-top: {{ section.settings.padding_top }}px;
    --section-padding-bottom: {{ section.settings.padding_bottom }}px;
  "
>
  <div class="order-1 md:order-1">
    <div class="sticky  top-[100px] mb-[25px] rounded-[15px] bg-[#F3F1E8] p-[20px] md:top-[150px] md:col-span-1 md:mb-0 md:p-[30px]">
      <h3 class="headline1 pb-[20px] text-[24px] md:pb-[30px] md:text-[30px]">Inneh√•ll</h3>
      <div class="mb-4">
        <div class="relative h-[5px] w-full overflow-hidden rounded-full bg-white">
          <div
            class="progress-bar absolute left-0 top-0 h-full rounded-full bg-[#EFD959] transition-all duration-300 ease-out"
            style="width: 0%"
          ></div>
        </div>
        <div class="progress-text headline1 pt-[15px] !text-[16px] text-[#545454] md:!text-[20px]">
          0% komplett
        </div>
      </div>
      <nav class="flex flex-col gap-[30px] pt-[30px] md:gap-[50px] md:pt-[50px]">
        {% comment %} Extract headings from article content {% endcomment %}
        {% assign content_lines = article.content | split: '<' %}
        {% for line in content_lines %}
          {% if line contains 'h1>'
            or line contains 'h2>'
            or line contains 'h3>'
            or line contains 'h4>'
            or line contains 'h5>'
            or line contains 'h6>'
          %}
            {% assign heading_text = line | split: '>' | last | split: '</' | first | strip %}
            {% if heading_text != blank %}
              {% assign heading_id = heading_text | handleize %}
              <a
                href="#{{ heading_id }}"
                class="headline1 block !text-[18px] text-[#171717] transition-colors hover:text-[#efd959] md:!text-[25px]"
              >
                {{ heading_text }}
              </a>
            {% endif %}
          {% endif %}
        {% endfor %}
      </nav>
    </div>
  </div>
  <div class="order-1 md:order-2 md:col-span-2">
    <header>
      <h1 class="headline1 py-[20px] text-[32px] leading-[90%] md:py-[25px] md:text-[48px]">
        {{ article.title }}
      </h1>
    </header>

    {% if article.image %}
      <figure class="flex h-[250px] w-full overflow-hidden rounded-[15px] md:h-[379px]">
        {{
          article.image
          | image_url: width: 1600
          | image_tag: loading: 'lazy', class: 'w-full h-[250px] md:h-[379px] object-cover'
        }}
      </figure>
    {% endif %}

    <div class="rte flex flex-col gap-[25px]" id="article-content">
      {% comment %} Process article content to add IDs to headings using Liquid {% endcomment %}
      {% assign content = article.content %}

      {% comment %} Replace h1-h6 tags with versions that include IDs {% endcomment %}
      {% assign processed_content = content %}

      {% comment %} Handle h1 tags {% endcomment %}
      {% assign h1_parts = processed_content | split: '<h1>' %}
      {% assign processed_content = h1_parts[0] %}
      {% for part in h1_parts %}
        {% unless forloop.first %}
          {% assign h1_content = part | split: '</h1>' | first | strip_html | strip %}
          {% if h1_content != blank %}
            {% assign h1_id = h1_content | handleize %}
            {% assign h1_rest = part | split: '</h1>' | last %}
            {% assign processed_content = processed_content
              | append: '<h1 id="'
              | append: h1_id
              | append: '">'
              | append: h1_content
              | append: '</h1>'
              | append: h1_rest
            %}
          {% else %}
            {% assign processed_content = processed_content | append: '<h1>' | append: part %}
          {% endif %}
        {% endunless %}
      {% endfor %}

      {% comment %} Handle h2 tags {% endcomment %}
      {% assign h2_parts = processed_content | split: '<h2>' %}
      {% assign processed_content = h2_parts[0] %}
      {% for part in h2_parts %}
        {% unless forloop.first %}
          {% assign h2_content = part | split: '</h2>' | first | strip_html | strip %}
          {% if h2_content != blank %}
            {% assign h2_id = h2_content | handleize %}
            {% assign h2_rest = part | split: '</h2>' | last %}
            {% assign processed_content = processed_content
              | append: '<h2 id="'
              | append: h2_id
              | append: '">'
              | append: h2_content
              | append: '</h2>'
              | append: h2_rest
            %}
          {% else %}
            {% assign processed_content = processed_content | append: '<h2>' | append: part %}
          {% endif %}
        {% endunless %}
      {% endfor %}

      {% comment %} Handle h3 tags {% endcomment %}
      {% assign h3_parts = processed_content | split: '<h3>' %}
      {% assign processed_content = h3_parts[0] %}
      {% for part in h3_parts %}
        {% unless forloop.first %}
          {% assign h3_content = part | split: '</h3>' | first | strip_html | strip %}
          {% if h3_content != blank %}
            {% assign h3_id = h3_content | handleize %}
            {% assign h3_rest = part | split: '</h3>' | last %}
            {% assign processed_content = processed_content
              | append: '<h3 id="'
              | append: h3_id
              | append: '">'
              | append: h3_content
              | append: '</h3>'
              | append: h3_rest
            %}
          {% else %}
            {% assign processed_content = processed_content | append: '<h3>' | append: part %}
          {% endif %}
        {% endunless %}
      {% endfor %}

      {{ processed_content }}
    </div>
  </div>
</article>

{% stylesheet %}
  img {
    width: 100%;
    height: 379px;
    object-fit: cover;
    border-radius: 15px;
    display: block;
  }
  /* Rich text defaults: style p vs headings differently */
  p {
    font-family: var(--font-halyard--family);
    font-weight: 300;
    font-size: 20px;
    color: #171717;
    opacity: 0.8;
    line-height: 110%;
    border: none;
    outline: none;
    cursor: pointer;
  }
  h2,
  h3,
  h4,
  h5,
  h6 {
    font-family: var(--font-halyard--family);
    font-weight: 400;
    font-size: 30px;
    line-height: 90%;
  }

  /* Ensure images inside article body content are styled */
  .section-article .rte img {
    width: 100%;
    height: 379px;
    object-fit: cover;
    border-radius: 15px;
    display: block;
  }

  /* When the CMS wraps images in <p>, remove paragraph padding and style the image */
  .section-article .rte p > img {
    width: 100%;
    height: 379px;
    object-fit: cover;
    border-radius: 15px;
    display: block;
  }
  .section-article .rte p:has(> img) {
    padding-top: 0;
    padding-bottom: 0;
  }

  /* Table of contents active link styling */
  .section-article nav a {
    position: relative;
    transition: all 0.3s ease;
    padding: 8px 0;
    border-radius: 4px;
  }

  .section-article nav a.active {
    color: #efd959 !important;
    font-weight: 600;
    transform: translateX(5px);
    background-color: rgba(239, 217, 89, 0.1);
  }

  .section-article nav a.active::before {
    content: '';
    position: absolute;
    left: -10px;
    top: 50%;
    transform: translateY(-50%);
    width: 4px;
    height: 20px;
    background-color: #efd959;
    border-radius: 2px;
  }

  /* Progress bar animation */
  .progress-bar {
    transition: width 0.3s ease-out;
  }

  /* Mobile optimizations */
  @media (max-width: 768px) {
    .section-article {
      padding-left: 16px;
      padding-right: 16px;
    }

    .section-article nav a {
      padding: 12px 0;
      font-size: 18px;
      line-height: 1.2;
    }

    .section-article nav a.active {
      transform: translateX(3px);
      padding-left: 8px;
    }

    .section-article nav a.active::before {
      left: -8px;
      width: 3px;
      height: 16px;
    }

    /* Make sticky sidebar less sticky on mobile */
    .section-article .sticky {
      position: relative;
      top: auto !important;
    }

    /* Improve touch targets */
    .section-article nav a {
      min-height: 44px;
      display: flex;
      align-items: center;
    }

    /* Reduce image height on mobile */
    .section-article .rte img {
      height: 250px;
    }

    .section-article .rte p > img {
      height: 250px;
    }
  }
{% endstylesheet %}

<script src="{{ 'article-toc.js' | asset_url }}" defer></script>
