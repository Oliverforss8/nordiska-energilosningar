<section
  class="contact-form-section layout   py-[60px] md:py-[85px]"
  id="kontakt"
>
  {% if section.settings.header_button_url != blank %}
    <a
      href="{{ section.settings.header_button_url }}"
      class="knappetikett2 z-10 inline-block rounded-full bg-transparent p-[15px] font-[400] text-[#171717]"
      style="border: 1px solid #171717;"
    >
      {{ section.settings.header_button_text }}
    </a>
  {% endif %}

  <h2 class="headline1 py-[50px] text-[#171717]">
    {{ section.settings.heading }}
  </h2>

  <div
    id="success-message"
    class="hidden rounded-[15px] bg-[#F3F1E8] p-[40px] text-center md:p-[60px]"
  >
    <h3 class="headline1 mb-[20px] text-[#171717]">Tack för ditt meddelande!</h3>
    <p class="body1 text-[#171717]/80">Vi återkommer till dig så snart som möjligt.</p>
  </div>

  <form
    action="https://formspree.io/f/mdkllzwo"
    method="POST"
    id="contact-form"
    class="grid grid-cols-1 gap-x-[20px] md:grid-cols-2"
  >
    {% for block in section.blocks %}
      {% if block.type == 'form_field' %}
        {% liquid
          assign field_type = block.settings.field_type | default: 'text'
          assign field_name = block.settings.name | default: block.settings.label | handleize
          assign is_required = block.settings.required
          assign placeholder = block.settings.placeholder | default: ''
          assign rows = block.settings.rows | default: 4
          assign pattern = block.settings.pattern
        %}
        <div class="flex flex-col col-span-full{% if field_type == 'text' or field_type == 'email' or field_type == 'tel' %} md:col-span-1{% endif %}{% if forloop.index > 2 %} pt-[30px]{% endif %}">
          <label for="{{ field_name }}" class="body1 mb-[15px] text-[#171717]">
            {{ block.settings.label }}
          </label>
          {% if field_type == 'textarea' %}
            <textarea
              id="{{ field_name }}"
              name="{{ field_name }}"
              rows="{{ rows }}"
              {% if is_required %}
                required
              {% endif %}
              class="h-[80px] rounded-full border-0 bg-[#F6F6F6] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
              {% if placeholder != blank %}
                placeholder="{{ placeholder | escape }}"
              {% endif %}
            ></textarea>
          {% else %}
            <input
              type="{{ field_type }}"
              id="{{ field_name }}"
              name="{{ field_name }}"
              {% if is_required %}
                required
              {% endif %}
              {% if pattern != blank %}
                pattern="{{ pattern }}"
              {% endif %}
              class="h-[40px] rounded-full border-0 bg-[#F6F6F6] px-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
              {% if placeholder != blank %}
                placeholder="{{ placeholder | escape }}"
              {% endif %}
            >
          {% endif %}
        </div>
      {% endif %}
    {% endfor %}
    <div class="col-span-2 flex flex-col py-[50px]">
      <div class=" body1 flex flex-row gap-[5px] text-[25px] text-[#171717]">
        Hur kan vi hjälpa dig?
        <span class=" mt-[5px]  text-[15px] text-[#171717]/80"> Klicka för att välja* </span>
      </div>
      <div class=" flex flex-row flex-wrap gap-[10px] pt-[15px]">
        {% for block in section.blocks %}
          {% if block.type == 'service_option' %}
            {% liquid
              assign service_key = block.settings.service_key | default: block.settings.label | handleize
            %}
            <button
              type="button"
              class="service-option knappetikett rounded-full bg-[#F6F6F6] p-[13px] font-[300] text-[#171717]"
              data-service="{{ service_key }}"
            >
              {{ block.settings.label | default: 'Tjänst' }}
            </button>
          {% endif %}
        {% endfor %}
      </div>
      <input
        type="hidden"
        name="services"
        id="selected-services"
        value=""
      >
    </div>
    <div class="col-span-2 flex flex-col">
      <label for="message" class="body1 mb-[15px] text-[#171717]"> Meddelande </label>
      <textarea
        id="message"
        name="message"
        rows="4"
        class="h-[80px] rounded-[25px] border-0 bg-[#F6F6F6] px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
      ></textarea>
    </div>
    <button
      type="submit"
      class="knappetikett col-span-2 mt-[30px] w-full rounded-full py-[13px]"
      style="background: linear-gradient(135deg, #FFA94D 0%, #FF4E33 100%);"
    >
      Skicka in
    </button>
  </form>
</section>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const serviceButtons = document.querySelectorAll('.service-option, .service-btn');
    const hiddenInput = document.getElementById('selected-services');
    const contactForm = document.getElementById('contact-form');
    const successMessage = document.getElementById('success-message');
    let selectedServices = []; // Start with no services selected

    serviceButtons.forEach((button) => {
      button.addEventListener('click', function () {
        const service = this.getAttribute('data-service');

        if (this.classList.contains('active')) {
          // Remove from selection
          this.classList.remove('active');
          this.classList.remove('bg-gradient-to-r');
          this.classList.add('bg-[#F6F6F6]');
          this.classList.remove('font-[400]');
          this.classList.add('font-[300]');
          this.style.background = '';

          selectedServices = selectedServices.filter((s) => s !== service);
        } else {
          // Add to selection
          this.classList.add('active');
          this.classList.remove('bg-[#F6F6F6]');
          this.classList.add('font-[400]');
          this.classList.remove('font-[300]');
          this.style.background = 'linear-gradient(135deg, #FFA94D 0%, #FF4E33 100%)';

          selectedServices.push(service);
        }

        // Update hidden input
        hiddenInput.value = selectedServices.join(', ');
      });
    });

    // Handle form submission
    contactForm.addEventListener('submit', async function (e) {
      e.preventDefault();

      const formData = new FormData(contactForm);
      const submitButton = contactForm.querySelector('button[type="submit"]');
      const originalButtonText = submitButton.textContent;

      try {
        // Disable submit button and show loading state
        submitButton.disabled = true;
        submitButton.textContent = 'Skickar...';

        // Submit form via AJAX
        const response = await fetch(contactForm.action, {
          method: 'POST',
          body: formData,
          headers: {
            Accept: 'application/json',
          },
        });

        if (response.ok) {
          // Hide form and show success message
          contactForm.style.display = 'none';
          successMessage.classList.remove('hidden');

          // Scroll to success message
          successMessage.scrollIntoView({ behavior: 'smooth', block: 'center' });
        } else {
          throw new Error('Form submission failed');
        }
      } catch (error) {
        // Re-enable button and show error
        submitButton.disabled = false;
        submitButton.textContent = originalButtonText;
        alert('Ett fel uppstod. Försök igen senare.');
      }
    });
  });
</script>

{% schema %}
{
  "name": "Kontakt Form",
  "tag": "section",
  "class": "contact-form-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Kontakta oss"
    },
    {
      "type": "text",
      "id": "header_button_text",
      "label": "Header Button Text"
    },
    {
      "type": "url",
      "id": "header_button_url",
      "label": "Header Button URL"
    }
  ],
  "max_blocks": 50,
  "blocks": [
    {
      "type": "form_field",
      "name": "Formulärfält",
      "limit": 30,
      "settings": [
        { "type": "text", "id": "label", "label": "Etikett", "default": "För- & efternamn" },
        {
          "type": "text",
          "id": "name",
          "label": "Fältnamn (valfritt)",
          "info": "Om tomt används etiketten som namn (handleized)"
        },
        {
          "type": "select",
          "id": "field_type",
          "label": "Typ",
          "options": [
            { "value": "text", "label": "Text" },
            { "value": "email", "label": "E‑post" },
            { "value": "tel", "label": "Telefon" },
            { "value": "textarea", "label": "Textarea" }
          ],
          "default": "text"
        },
        { "type": "text", "id": "placeholder", "label": "Platshållare (valfritt)" },
        { "type": "checkbox", "id": "required", "label": "Obligatoriskt", "default": true },
        {
          "type": "text",
          "id": "pattern",
          "label": "HTML5 pattern (valfritt)",
          "info": "RegExp för validering, t.ex.^[0-9\\- +()]*$ för telefon"
        },
        {
          "type": "number",
          "id": "rows",
          "label": "Textarea rader",
          "default": 4,
          "info": "Gäller endast textarea"
        }
      ]
    },
    {
      "type": "service_option",
      "name": "Tjänsteval",
      "limit": 12,
      "settings": [
        { "type": "text", "id": "label", "label": "Etikett", "default": "Solceller" },
        {
          "type": "text",
          "id": "service_key",
          "label": "Nyckel (valfritt)",
          "info": "Används som data-service. Lämna tomt för att använda etiketten."
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Contact Form",
      "blocks": [
        {
          "type": "form_field",
          "settings": { "label": "För- & efternamn", "field_type": "text", "required": true }
        },
        {
          "type": "form_field",
          "settings": { "label": "Mailadress", "field_type": "email", "required": true }
        },
        {
          "type": "form_field",
          "settings": { "label": "Företagsnamn", "field_type": "text", "required": false }
        },
        {
          "type": "form_field",
          "settings": {
            "label": "Telefonnummer",
            "field_type": "tel",
            "required": false,
            "pattern": "^[0-9\\- +()]*$"
          }
        },
        {
          "type": "form_field",
          "settings": {
            "label": "Meddelande",
            "field_type": "textarea",
            "required": false,
            "rows": 4
          }
        },
        { "type": "service_option", "settings": { "label": "Solceller" } },
        { "type": "service_option", "settings": { "label": "Energilagring" } },
        { "type": "service_option", "settings": { "label": "Laddbox" } },
        { "type": "service_option", "settings": { "label": "Serviceavtal" } }
      ]
    }
  ]
}
{% endschema %}
