{% liquid
  assign section_id = section.settings.custom_id | default: section.id
  assign section_class = 'section-' | append: section.type
%}

<section
  id="{{ section_id }}"
  class="{{ section_class }} "
>
  <div class="layout pt-[100px] md:pt-[150px] ">
    <div class="headline1 pb-[60px] text-[20px] font-[300]">
      <nav aria-label="Breadcrumb">
        <a href="{{ routes.root_url }}" class="text-[#171717] transition-opacity hover:opacity-70">
          Hem
        </a>
        <span class="mx-2">/</span>
        {% if collection %}
          <a
            href="{{ collection.url }}"
            class="text-[#171717] transition-opacity hover:opacity-70"
          >
            {{ collection.title }}
          </a>
          <span class="mx-2">/</span>
        {% elsif product.collections.size > 0 %}
          <a
            href="{{ product.collections.first.url }}"
            class="text-[#171717] transition-opacity hover:opacity-70"
          >
            {{ product.collections.first.title }}
          </a>
          <span class="mx-2">/</span>
        {% endif %}
        <span class="font-[400]">{{ product.title }}</span>
      </nav>
    </div>
    <div class="flex flex-col gap-[30px] md:flex-row md:gap-[50px]">
      <!-- Product Images -->
      <div class="w-full space-y-4 md:w-auto">
        <div class="flex rounded-[15px] bg-[#F6F6F6] px-[20px] py-[20px] md:px-[90px] md:py-[40px]">
          {% if product.featured_media %}
            <div
              class="flex h-[280px] w-full md:h-[300px] md:w-[300px]"
              id="main-product-image"
            >
              {%
                render 'image',
                image: product.featured_media,
                alt: product.featured_media.alt | default: product.title,
                class: 'image--cover'
              %}
            </div>
          {% endif %}
        </div>

        {% if product.media.size > 1 %}
          <div class="flex gap-3 overflow-x-auto pb-2">
            {% for media in product.media offset: 1 limit: 4 %}
              <div
                class="h-[60px] w-[60px] flex-shrink-0 cursor-pointer overflow-hidden rounded-[10px] bg-[#F6F6F6] transition-opacity hover:opacity-80 md:h-[80px] md:w-[80px]"
                data-thumbnail
                data-media-id="{{ media.id }}"
              >
                {%
                  render 'image',
                  image: media,
                  alt: media.alt | default: product.title,
                  class: 'image--cover'
                %}
              </div>
            {% endfor %}
          </div>
        {% endif %}
      </div>

      <!-- Product Details -->
      <div class="product-details w-full">
        <div class="">
          <h1 class=" headline2">
            {{ product.title }}
          </h1>

          {% if product.description != blank %}
            <div class="body1 py-[30px] text-[#171717]/80 md:py-[50px]">
              {{ product.description }}
            </div>
          {% endif %}

          {% if product.price > 0 %}
            <!-- Variant Selectors -->

            <!-- Price Display -->
            <div class="mb-[30px] flex items-center space-x-3 md:mb-0">
              <div id="variant-price-display">
                {% assign current_variant = product.selected_or_first_available_variant %}
                {% if current_variant.compare_at_price > current_variant.price %}
                  <span class="text-lg text-gray-500 line-through" id="compare-price">
                    {{ current_variant.compare_at_price | money }}
                  </span>
                {% endif %}
                <span class="headline2" id="current-price">
                  {{ current_variant.price | money }}
                </span>
              </div>
            </div>

            <!-- Mobile-optimized button layout -->
            <div class="">
              <!-- Quantity selector -->
              <div class="flex justify-start md:hidden">
                <div
                  class="headline1 flex min-h-[48px] flex-row items-center gap-[10px] rounded-[10px] bg-transparent py-[10px] pl-[20px] pr-[15px] text-[18px] md:text-[20px]"
                  style="border: 1px solid #171717 !important;"
                >
                  <span id="quantity-display-mobile">1</span>
                  <div class="flex cursor-pointer flex-col gap-[0px]">
                    <!-- Up arrow (increase) -->
                    <button
                      type="button"
                      class="quantity-increase transition-opacity hover:opacity-70"
                      onclick="updateQuantity(1)"
                      style="background: none; border: none; padding: 0; cursor: pointer;"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="13"
                        height="9"
                        viewBox="0 0 13 9"
                        fill="none"
                      >
                        <path d="M11.7159 6.71C11.8096 6.61704 11.884 6.50644 11.9348 6.38458C11.9856 6.26272 12.0117 6.13201 12.0117 6C12.0117 5.86799 11.9856 5.73728 11.9348 5.61542C11.884 5.49356 11.8096 5.38296 11.7159 5.29L6.71592 0.29C6.62296 0.196272 6.51236 0.121877 6.3905 0.0711086C6.26864 0.0203399 6.13793 -0.00579834 6.00592 -0.00579834C5.87391 -0.00579834 5.7432 0.0203399 5.62134 0.0711086C5.49948 0.121877 5.38888 0.196272 5.29592 0.29L0.295921 5.29C0.202193 5.38296 0.127797 5.49356 0.0770283 5.61542C0.0262594 5.73728 0.00012207 5.86799 0.00012207 6C0.00012207 6.13201 0.0262594 6.26272 0.0770283 6.38458C0.127797 6.50644 0.202193 6.61704 0.295921 6.71C0.388885 6.80373 0.499484 6.87812 0.621344 6.92889C0.743203 6.97966 0.873909 7.0058 1.00592 7.0058C1.13793 7.0058 1.26864 6.97966 1.3905 6.92889C1.51236 6.87812 1.62296 6.80373 1.71592 6.71L6.00592 2.41L10.2959 6.71C10.3889 6.80373 10.4995 6.87812 10.6213 6.92889C10.7432 6.97966 10.8739 7.0058 11.0059 7.0058C11.1379 7.0058 11.2686 6.97966 11.3905 6.92889C11.5124 6.87812 11.623 6.80373 11.7159 6.71Z" fill="#171717"/>
                      </svg>
                    </button>

                    <!-- Down arrow (decrease) -->
                    <button
                      type="button"
                      class="quantity-decrease transition-opacity hover:opacity-70"
                      onclick="updateQuantity(-1)"
                      style="background: none; border: none; padding: 0; cursor: pointer;"
                    >
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="13"
                        height="9"
                        viewBox="0 0 13 9"
                        fill="none"
                      >
                        <path d="M6.71592 8.71L11.7159 3.71C11.8092 3.6168 11.8831 3.5061 11.9336 3.3842C11.984 3.2624 12.01 3.1319 12.01 3C12.01 2.7337 11.9042 2.4783 11.7159 2.29C11.6227 2.1968 11.512 2.1228 11.3902 2.0723C11.2683 2.0219 11.1378 1.9959 11.0059 1.9959C10.7396 1.9959 10.4842 2.1017 10.2959 2.29L6.00592 6.59L1.71592 2.29C1.62296 2.1963 1.51236 2.1219 1.3905 2.0711C1.26864 2.0203 1.13793 1.9942 1.00592 1.9942C0.873909 1.9942 0.743203 2.0203 0.621344 2.0711C0.499484 2.1219 0.388885 2.1963 0.295921 2.29C0.202193 2.383 0.127797 2.4936 0.0770283 2.6154C0.0262594 2.7373 0.00012207 2.868 0.00012207 3C0.00012207 3.132 0.0262594 3.2627 0.0770283 3.3846C0.127797 3.5064 0.202193 3.617 0.295921 3.71L5.29592 8.71C5.38888 8.8037 5.49948 8.8781 5.62134 8.9289C5.7432 8.9797 5.87391 9.0058 6.00592 9.0058C6.13793 9.0058 6.26864 8.9797 6.3905 8.9289C6.51236 8.8781 6.62296 8.8037 6.71592 8.71Z" fill="#171717"/>
                      </svg>
                    </button>
                  </div>

                  <!-- Hidden input to store the actual quantity -->
                  <input
                    type="hidden"
                    id="quantity-input"
                    value="1"
                    min="1"
                    max="{{ product.selected_or_first_available_variant.inventory_quantity | default: 99 }}"
                  >
                </div>
              </div>
              {% unless product.has_only_default_variant %}
                <div class="variant-selectors rounded-[10px]  border  pt-[50px] ">
                  {% for option in product.options_with_values %}
                    <div class="variant-option">
                      <label class="body1 mb-2 block text-[16px] font-medium md:text-[18px]">
                        {{ option.name }}
                      </label>
                      <select
                        style="  border: 1px solid #171717 !important; "
                        class="variant-select body1 w-full rounded-[10px] border border-[#171717] bg-white px-[15px] py-[12px] text-[16px] focus:outline-none md:text-[18px] "
                        data-option-position="{{ option.position }}"
                        data-option-name="{{ option.name }}"
                      >
                        {% for value in option.values %}
                          <option
                            value="{{ value }}"
                            {% if option.selected_value == value %}
                              selected
                            {% endif %}
                          >
                            {{ value }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                  {% endfor %}
                </div>

                <!-- Upsell Products Section -->
                {% if section.blocks.size > 0 %}
                  <div class="upsell-products-wrapper pt-[30px] md:pt-[50px]">
                    {% for block in section.blocks %}
                      {% case block.type %}
                        {% when 'upsell_product' %}
                          {% if block.settings.upsell_product != blank %}
                            {% assign upsell_product = block.settings.upsell_product %}
                            <div class="upsell-product-card mb-[20px] rounded-[15px] border border-[#171717] p-[20px] md:p-[30px]" {{ block.shopify_attributes }}>
                              <div class="flex flex-col gap-[20px]">
                                <!-- Header with checkbox -->
                                <div class="flex items-start justify-between gap-[15px]">
                                  <div class="flex items-start gap-[15px]">
                                    <input
                                      type="checkbox"
                                      id="upsell-{{ upsell_product.id }}"
                                      class="upsell-checkbox mt-[5px] h-[20px] w-[20px] cursor-pointer"
                                      data-product-id="{{ upsell_product.id }}"
                                      data-variant-id="{{ upsell_product.selected_or_first_available_variant.id }}"
                                      data-price="{{ upsell_product.price }}"
                                    >
                                    <label for="upsell-{{ upsell_product.id }}" class="cursor-pointer">
                                      <div class="headline1 text-[20px] md:text-[24px]">
                                        {{ block.settings.upsell_title | default: upsell_product.title }}
                                      </div>
                                      {% if block.settings.upsell_description != blank %}
                                        <div class="body1 mt-[10px] text-[14px] text-[#171717]/70 md:text-[16px]">
                                          {{ block.settings.upsell_description }}
                                        </div>
                                      {% endif %}
                                    </label>
                                  </div>
                                  <div class="headline1 text-[18px] md:text-[20px]">
                                    +{{ upsell_product.price | money }}
                                  </div>
                                </div>

                                <!-- Product Info -->
                                <div class="flex items-center gap-[15px] md:gap-[20px]">
                                  {% if upsell_product.featured_image %}
                                    <div class="h-[60px] w-[60px] flex-shrink-0 overflow-hidden rounded-[10px] bg-[#F6F6F6] md:h-[80px] md:w-[80px]">
                                      {%
                                        render 'image',
                                        image: upsell_product.featured_image,
                                        alt: upsell_product.featured_image.alt | default: upsell_product.title,
                                        class: 'image--cover'
                                      %}
                                    </div>
                                  {% endif %}
                                  <div class="flex-1">
                                    <div class="body1 text-[14px] font-medium text-[#171717] md:text-[16px]">
                                      {{ upsell_product.title }}
                                    </div>
                                    {% if upsell_product.description != blank %}
                                      <div class="body1 mt-[5px] text-[12px] text-[#171717]/60 md:text-[14px]">
                                        {{ upsell_product.description | strip_html | truncate: 80 }}
                                      </div>
                                    {% endif %}
                                  </div>
                                </div>
                              </div>
                            </div>
                          {% endif %}
                      {% endcase %}
                    {% endfor %}
                  </div>
                {% endif %}

                <!-- Installation Option -->
                {% if section.settings.show_installation and section.settings.installation_product != blank %}
                  {% assign installation_product = section.settings.installation_product %}
                  <div class="installation-wrapper pt-[15px]">
                    <div class="installation-card rounded-[15px] border border-[#171717] p-[20px] md:p-[30px]">
                      <div class="flex items-start justify-between gap-[15px]">
                        <div class="flex items-start gap-[15px]">
                          <input
                            type="checkbox"
                            id="installation-checkbox"
                            class="installation-checkbox mt-[5px] h-[20px] w-[20px] cursor-pointer"
                            data-variant-id="{{ installation_product.selected_or_first_available_variant.id }}"
                            data-price="{{ installation_product.price }}"
                            checked
                          >
                          <label for="installation-checkbox" class="cursor-pointer">
                            <div class="headline1 text-[20px] md:text-[24px]">
                              {{ section.settings.installation_title | default: installation_product.title }}
                            </div>
                            {% if section.settings.installation_description != blank %}
                              <div class="body1 mt-[10px] text-[14px] text-[#171717]/70 md:text-[16px]">
                                {{ section.settings.installation_description }}
                              </div>
                            {% elsif installation_product.description != blank %}
                              <div class="body1 mt-[10px] text-[14px] text-[#171717]/70 md:text-[16px]">
                                {{ installation_product.description | strip_html | truncate: 150 }}
                              </div>
                            {% endif %}
                          </label>
                        </div>
                        <div class="headline1 text-[18px] md:text-[20px]">
                          +{{ installation_product.price | money }}
                        </div>
                      </div>
                    </div>
                  </div>

                  <!-- Green Deduction Options (only visible when installation is selected) -->
                  <div class="green-deduction-wrapper pt-[15px]" id="green-deduction-wrapper">
                    <div class="rounded-[15px] bg-[#F3F1E8] p-[20px] md:p-[30px]">
                      <div class="headline1 mb-[15px] text-[18px] md:text-[20px]">
                        Välj grönt avdrag
                      </div>
                      
                      <!-- Grönt avdrag 1 -->
                      <div class="green-deduction-option mb-[15px] flex items-start gap-[15px] rounded-[10px] border border-[#171717]/20 p-[15px] transition-all hover:border-[#171717]">
                        <input
                          type="radio"
                          id="green-deduction-1"
                          name="green-deduction"
                          class="green-deduction-radio mt-[5px] h-[20px] w-[20px] cursor-pointer"
                          data-discount-code="AVDRAG1"
                        >
                        <label for="green-deduction-1" class="flex-1 cursor-pointer">
                          <div class="body1 font-medium text-[16px] md:text-[18px]">
                            {{ section.settings.green_deduction_1_title | default: 'Grönt avdrag 1' }}
                          </div>
                          {% if section.settings.green_deduction_1_description != blank %}
                            <div class="body1 mt-[5px] text-[12px] text-[#171717]/60 md:text-[14px]">
                              {{ section.settings.green_deduction_1_description }}
                            </div>
                          {% endif %}
                          <div class="body1 mt-[5px] text-[12px] text-[#171717]/50 md:text-[13px]">
                            Rabattkod: AVDRAG1
                          </div>
                        </label>
                      </div>

                      <!-- Grönt avdrag 2 -->
                      <div class="green-deduction-option flex items-start gap-[15px] rounded-[10px] border border-[#171717]/20 p-[15px] transition-all hover:border-[#171717]">
                        <input
                          type="radio"
                          id="green-deduction-2"
                          name="green-deduction"
                          class="green-deduction-radio mt-[5px] h-[20px] w-[20px] cursor-pointer"
                          data-discount-code="AVDRAG2"
                        >
                        <label for="green-deduction-2" class="flex-1 cursor-pointer">
                          <div class="body1 font-medium text-[16px] md:text-[18px]">
                            {{ section.settings.green_deduction_2_title | default: 'Grönt avdrag 2' }}
                          </div>
                          {% if section.settings.green_deduction_2_description != blank %}
                            <div class="body1 mt-[5px] text-[12px] text-[#171717]/60 md:text-[14px]">
                              {{ section.settings.green_deduction_2_description }}
                            </div>
                          {% endif %}
                          <div class="body1 mt-[5px] text-[12px] text-[#171717]/50 md:text-[13px]">
                            Rabattkod: AVDRAG2
                          </div>
                        </label>
                      </div>
                    </div>
                  </div>
                {% endif %}
              {% endunless %}

              <!-- Action buttons - stacked on mobile, row on desktop -->
              <div class="flex w-full flex-col gap-[10px] md:flex-row md:pt-[25px]">
                <div class="flex justify-center md:justify-start">
                  <div
                    class="headline1 hidden min-h-[48px] flex-row items-center gap-[10px] rounded-[10px] bg-transparent py-[15px] pl-[20px] pr-[15px] text-[18px] md:flex md:text-[20px]"
                    style="border: 1px solid #171717 !important;"
                  >
                    <span id="quantity-display-desktop">1</span>
                    <div class="flex cursor-pointer flex-col gap-[2px]">
                      <!-- Up arrow (increase) -->
                      <button
                        type="button"
                        class="quantity-increase transition-opacity hover:opacity-70"
                        onclick="updateQuantity(1)"
                        style="background: none; border: none; padding: 0; cursor: pointer;"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="13"
                          height="9"
                          viewBox="0 0 13 9"
                          fill="none"
                        >
                          <path d="M11.7159 6.71C11.8096 6.61704 11.884 6.50644 11.9348 6.38458C11.9856 6.26272 12.0117 6.13201 12.0117 6C12.0117 5.86799 11.9856 5.73728 11.9348 5.61542C11.884 5.49356 11.8096 5.38296 11.7159 5.29L6.71592 0.29C6.62296 0.196272 6.51236 0.121877 6.3905 0.0711086C6.26864 0.0203399 6.13793 -0.00579834 6.00592 -0.00579834C5.87391 -0.00579834 5.7432 0.0203399 5.62134 0.0711086C5.49948 0.121877 5.38888 0.196272 5.29592 0.29L0.295921 5.29C0.202193 5.38296 0.127797 5.49356 0.0770283 5.61542C0.0262594 5.73728 0.00012207 5.86799 0.00012207 6C0.00012207 6.13201 0.0262594 6.26272 0.0770283 6.38458C0.127797 6.50644 0.202193 6.61704 0.295921 6.71C0.388885 6.80373 0.499484 6.87812 0.621344 6.92889C0.743203 6.97966 0.873909 7.0058 1.00592 7.0058C1.13793 7.0058 1.26864 6.97966 1.3905 6.92889C1.51236 6.87812 1.62296 6.80373 1.71592 6.71L6.00592 2.41L10.2959 6.71C10.3889 6.80373 10.4995 6.87812 10.6213 6.92889C10.7432 6.97966 10.8739 7.0058 11.0059 7.0058C11.1379 7.0058 11.2686 6.97966 11.3905 6.92889C11.5124 6.87812 11.623 6.80373 11.7159 6.71Z" fill="#171717"/>
                        </svg>
                      </button>

                      <!-- Down arrow (decrease) -->
                      <button
                        type="button"
                        class="quantity-decrease transition-opacity hover:opacity-70"
                        onclick="updateQuantity(-1)"
                        style="background: none; border: none; padding: 0; cursor: pointer;"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="13"
                          height="9"
                          viewBox="0 0 13 9"
                          fill="none"
                        >
                          <path d="M6.71592 8.71L11.7159 3.71C11.8092 3.6168 11.8831 3.5061 11.9336 3.3842C11.984 3.2624 12.01 3.1319 12.01 3C12.01 2.7337 11.9042 2.4783 11.7159 2.29C11.6227 2.1968 11.512 2.1228 11.3902 2.0723C11.2683 2.0219 11.1378 1.9959 11.0059 1.9959C10.7396 1.9959 10.4842 2.1017 10.2959 2.29L6.00592 6.59L1.71592 2.29C1.62296 2.1963 1.51236 2.1219 1.3905 2.0711C1.26864 2.0203 1.13793 1.9942 1.00592 1.9942C0.873909 1.9942 0.743203 2.0203 0.621344 2.0711C0.499484 2.1219 0.388885 2.1963 0.295921 2.29C0.202193 2.383 0.127797 2.4936 0.0770283 2.6154C0.0262594 2.7373 0.00012207 2.868 0.00012207 3C0.00012207 3.132 0.0262594 3.2627 0.0770283 3.3846C0.127797 3.5064 0.202193 3.617 0.295921 3.71L5.29592 8.71C5.38888 8.8037 5.49948 8.8781 5.62134 8.9289C5.7432 8.9797 5.87391 9.0058 6.00592 9.0058C6.13793 9.0058 6.26864 8.9797 6.3905 8.9289C6.51236 8.8781 6.62296 8.8037 6.71592 8.71Z" fill="#171717"/>
                        </svg>
                      </button>
                    </div>

                    <!-- Hidden input to store the actual quantity -->
                    <input
                      type="hidden"
                      id="quantity-input"
                      value="1"
                      min="1"
                      max="{{ product.selected_or_first_available_variant.inventory_quantity | default: 99 }}"
                    >
                  </div>
                </div>
                <button
                  class="knappetikett buy-now-btn flex min-h-[48px] w-full flex-row items-center justify-center gap-[20px] rounded-[10px] px-[20px] py-[17px] text-[#171717] md:w-auto"
                  style="background: linear-gradient(0deg, rgba(255, 255, 255, 0.20) 0%, rgba(255, 255, 255, 0.20) 100%), #EBCF2F;"
                  data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                >
                  Köp nu
                </button>
                <button
                  class="headline1 add-to-cart-btn flex min-h-[48px] w-full flex-row items-center justify-center gap-[10px] rounded-[10px] bg-transparent px-[20px] py-[15px] text-[18px] md:w-auto md:text-[20px]"
                  style="border: 1px solid #171717 !important;"
                  data-variant-id="{{ product.selected_or_first_available_variant.id }}"
                >
                  Lägg i varukorg
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="20"
                    height="18"
                    viewBox="0 0 25 22"
                    fill="none"
                    class="md:h-[22px] md:w-[25px]"
                  >
                    <path d="M11.4617 6.55556H21.0268C21.7143 6.55556 22.0575 6.55556 22.3094 6.66667C23.4225 7.16333 22.9253 8.41111 22.7383 9.30889C22.7209 9.39 22.685 9.46588 22.6334 9.5305C22.5819 9.59512 22.5161 9.64669 22.4413 9.68111C22.0849 9.85113 21.7802 10.1148 21.5592 10.4444M7.06199 6.55556H2.99662C2.30915 6.55556 1.96597 6.55556 1.71409 6.66667C0.600948 7.16333 1.09812 8.41111 1.28511 9.30889C1.30331 9.38967 1.33953 9.46519 1.39099 9.52969C1.44246 9.59419 1.50782 9.64598 1.58209 9.68111C1.89053 9.82463 2.16039 10.0408 2.36901 10.3115C2.57763 10.5821 2.71892 10.8994 2.78103 11.2367L3.43329 14.9867C3.71928 16.6367 3.81827 18.9933 5.24819 20.1556C6.29863 21 7.81105 21 10.837 21H13.6616M16.4115 16C16.9515 15.4378 18.3914 13.2222 19.1613 13.2222M19.1613 13.2222C19.9313 13.2222 21.3711 15.4378 21.9112 16M19.1613 13.2222V21M5.96205 9.88889L9.81184 1M15.3115 1L18.0614 6.55556" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>
          {% endif %}

          <!-- Additional Text Fields -->
          {% if product.metafields.custom.meta_falt_texter %}
            {% assign texter_metaobject = product.metafields.custom.meta_falt_texter.value %}

            <div class="flex flex-col gap-[15px] pt-[30px] md:flex-row md:gap-[20px] md:pt-[50px]">
              {% if texter_metaobject.text_1 != blank %}
                <div class="text-field w-full rounded-[15px] bg-[#F3F1E8] p-[20px] md:p-[30px]">
                  <div class="metafield-content">
                    {% assign text_1_data = texter_metaobject.text_1.value %}
                    {% for child in text_1_data.children %}
                      {% if child.type == 'heading' %}
                        {% if child.level == 2 %}
                          <h2>{{ child.children[0].value }}</h2>
                        {% elsif child.level == 3 %}
                          <h3>{{ child.children[0].value }}</h3>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              {% if texter_metaobject.text_2 != blank %}
                <div class="text-field w-full rounded-[15px] bg-[#F3F1E8] p-[20px] md:p-[30px]">
                  <div class="metafield-content">
                    {% assign text_2_data = texter_metaobject.text_2.value %}
                    {% for child in text_2_data.children %}
                      {% if child.type == 'heading' %}
                        {% if child.level == 2 %}
                          <h2>{{ child.children[0].value }}</h2>
                        {% elsif child.level == 3 %}
                          <h3>{{ child.children[0].value }}</h3>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              {% endif %}

              {% if texter_metaobject.text_3 != blank %}
                <div class="text-field w-full rounded-[15px] bg-[#F3F1E8] p-[20px] md:p-[30px]">
                  <div class="metafield-content">
                    {% assign text_3_data = texter_metaobject.text_3.value %}
                    {% for child in text_3_data.children %}
                      {% if child.type == 'heading' %}
                        {% if child.level == 2 %}
                          <h2>{{ child.children[0].value }}</h2>
                        {% elsif child.level == 3 %}
                          <h3>{{ child.children[0].value }}</h3>
                        {% endif %}
                      {% endif %}
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            </div>
          {% endif %}

          <div class="pt-[30px] md:pt-[50px]">
            <!-- Tekniska specifikationer Dropdown -->

            <!-- Mer information Dropdown -->
            <div
              class="dropdown-section"
              style="border-bottom: 1px solid #171717; border-top: 1px solid #171717;"
            >
              <div
                class="dropdown-trigger flex min-h-[48px] w-full cursor-pointer flex-row items-center justify-between py-[16px] md:py-[20px]"
                onclick='toggleDropdown("info-content", this)'
              >
                <div class="body1 text-[18px] md:text-[24px]">Mer information</div>
                <div class="dropdown-icon p-2">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="16"
                    height="16"
                    viewBox="0 0 16 16"
                    fill="none"
                  >
                    <path d="M1 8H15M8 1V15" stroke="#171717" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </div>
              </div>
              <div
                class="dropdown-content"
                id="info-content"
                style="display: none; padding-top: 16px; padding-bottom: 16px;"
              >
                {% if product.metafields.custom.mer_text != blank %}
                  <div class="body1 text-[14px] md:text-[16px]">
                    {{ product.metafields.custom.mer_text | metafield_text }}
                  </div>
                {% else %}
                  <p class="body1 text-[14px] md:text-[16px]">
                    Ingen ytterligare information tillgänglig.
                  </p>
                {% endif %}
              </div>
            </div>
          </div>
          {% if product.price == 0 %}
            <div class="pt-[50px] ">
              <div class="rounded-[15px] bg-[#F3F1E8] p-[50px]">
                <div class="flex flex-col">
                  <div class="headline1 text-[40px]">Offert förfrågan</div>
                  <div class=" body1 py-[30px] text-[20px] opacity-80">
                    Ett solcellssystem med batteri och AI-styrning gör att du inte bara producerar
                    egen el!
                  </div>
                  <form
                    class="flex flex-col gap-[15px] md:gap-[20px]"
                    id="quote-form"
                    action="https://formspree.io/f/mdkllzwo"
                    method="POST"
                  >
                    <input
                      class="body1 h-[45px] rounded-[10px] bg-white pl-[15px] text-[16px] text-[#171717]/85 md:text-[18px]"
                      placeholder="För- & efternamn"
                      type="text"
                      name="name"
                      required
                    >
                    <input
                      class="body1 h-[45px] rounded-[10px] bg-white pl-[15px] text-[16px] text-[#171717]/85 md:text-[18px]"
                      placeholder="E-postadress"
                      type="email"
                      name="email"
                      required
                    >
                    <input
                      class="body1 h-[45px] rounded-[10px] bg-white pl-[15px] text-[16px] text-[#171717]/85 md:text-[18px]"
                      placeholder="Telefonnummer"
                      type="tel"
                      name="phone"
                    >
                    <input
                      class="body1 h-[45px] rounded-[10px] bg-white pl-[15px] text-[16px] text-[#171717]/85 md:text-[18px]"
                      placeholder="Adress"
                      type="text"
                      name="address"
                    >
                    <div class="body1 flex flex-col gap-[5px] text-[20px] md:flex-row md:text-[25px]">
                      Hur kan vi hjälpa dig?
                      <span class="text-[13px] opacity-70 md:text-[15px]">
                        Klicka för att välja*
                      </span>
                    </div>
                    <div class="flex flex-col gap-[10px] md:flex-row">
                      <button
                        type="button"
                        class="headline1 service-option flex flex-row items-center justify-center gap-[10px] rounded-[10px] bg-white px-[15px] py-[10px] text-[18px] md:text-[20px]"
                        data-service="solceller"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="29"
                          height="18"
                          viewBox="0 0 29 18"
                          fill="none"
                        >
                          <path d="M28.158 10.9256H12.7738L6.98633 1H22.3705L28.158 10.9256Z" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M24.0185 8.69895L20.5454 2.77808H11.0137L14.4867 8.69895H24.0185Z" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M22.1621 5.73865H12.8701" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M15.8389 2.83813L19.192 8.63916" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M6.95442 1L1.16699 10.9256H3.20773L5.28695 7.48052" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M3.20801 10.9255V16.9999H14.0598V10.9255" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M14.0596 17.0001H26.2569V10.9856" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M9.86596 16.9999V12.9615H6.68652V16.9999" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Solceller
                      </button>
                      <button
                        type="button"
                        class="headline1 service-option flex flex-row items-center justify-center gap-[10px] rounded-[10px] bg-white px-[15px] py-[10px] text-[18px] md:text-[20px]"
                        data-service="laddbox"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="25"
                          height="18"
                          viewBox="0 0 25 18"
                          fill="none"
                        >
                          <path d="M7.65948 11.3927C6.14107 11.3927 4.91016 12.6236 4.91016 14.142C4.91016 15.6604 6.14107 16.8914 7.65948 16.8914C9.17789 16.8914 10.4088 15.6604 10.4088 14.142C10.4088 12.6236 9.17785 11.3927 7.65948 11.3927Z" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M4.42336 3.96602L4.2199 6.05353L1.25195 6.35472M1.25195 2.78259C4.65122 2.78259 8.80464 3.18546 8.80464 3.18546L6.82778 5.86428L4.2199 6.05358" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M14.2494 7.16021C13.5714 6.04852 12.3365 4.2139 11.8366 3.67599C11.3155 3.11518 13.8323 2.53408 12.728 2.23456C10.527 1.63753 4.65011 1.41443 1.25165 1.41443C0.939933 1.41443 1.53172 1.41595 1.25165 1.41924" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M9.20996 10.3246C10.1831 10.6664 10.9727 11.3936 11.3933 12.3353L11.9 13.4698L13.8561 13.2624" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M1.25195 14.6555H3.38022L3.58082 13.2163C3.73513 12.1091 4.52556 11.1283 5.47664 10.5409" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M12.1346 6.92986L11.1736 6.43132C10.9144 6.27267 10.812 5.92281 10.9394 5.63031L12.0741 4.0697" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M1.18457 17.0001H23.7905" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M19.625 16.8913V12.5834" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M21.8779 12.5834V16.8913" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M24.0129 11.954L21.9771 12.4686C21.1831 12.6692 20.3201 12.6692 19.5261 12.4686L17.4902 11.954V1.66503L19.5261 1.15052C20.3201 0.949826 21.1831 0.949826 21.9771 1.15052L24.0129 1.66503V11.954Z" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M21.1041 5.34875L20.1318 6.8001H21.3709L20.6104 8.27022" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M9.9209 8.46094H13.3772C14.1556 8.46094 14.8108 9.04324 14.9023 9.81622L15.3872 13.7243C15.4307 14.0922 15.7426 14.3693 16.1131 14.3693H17.4837C17.8873 14.3693 18.2146 14.0421 18.2146 13.6384V12.2126" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M9.921 9.14697H8.81256C8.43067 9.14697 8.12109 8.8374 8.12109 8.45551C8.12109 8.07361 8.43067 7.76404 8.81256 7.76404H9.921V9.14697Z" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Laddbox
                      </button>
                      <button
                        type="button"
                        class="headline1 service-option flex flex-row items-center justify-center gap-[10px] rounded-[10px] bg-white px-[15px] py-[10px] text-[18px] md:text-[20px]"
                        data-service="batteri"
                      >
                        <svg
                          xmlns="http://www.w3.org/2000/svg"
                          width="11"
                          height="18"
                          viewBox="0 0 11 18"
                          fill="none"
                        >
                          <path d="M8.14291 11.8178V1.48787L5.689 1.0896C4.95299 0.970133 4.20256 0.970133 3.46661 1.0896L1.0127 1.48787V11.8178L3.46661 12.2161C4.20261 12.3355 4.95305 12.3355 5.689 12.2161L8.14291 11.8178Z" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M5.5791 12.448V16.9435" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M3.57617 16.9435V12.448" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M5.05313 4.68481L3.74316 6.64017H5.41254L4.38795 8.62074" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M8.14258 4.68481L9.52867 5.3987V8.24138H8.14258" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M9.52937 8.24146V13.0073C9.52937 13.6173 9.03485 14.1118 8.42484 14.1118C7.81483 14.1118 7.32031 13.6173 7.32031 13.0073V12.0734" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                          <path d="M2.1748 17H7.01923" stroke="#171717" stroke-miterlimit="10" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        Batteri
                      </button>
                    </div>

                    <!-- Hidden fields with product information -->
                    <input
                      type="hidden"
                      name="selected_service"
                      id="selected_service"
                    >
                    <input
                      type="hidden"
                      name="product_title"
                      value="{{ product.title }}"
                    >
                    <input
                      type="hidden"
                      name="product_handle"
                      value="{{ product.handle }}"
                    >
                    <input
                      type="hidden"
                      name="product_id"
                      value="{{ product.id }}"
                    >
                    <input
                      type="hidden"
                      name="product_url"
                      value="{{ shop.secure_url }}{{ product.url }}"
                    >
                    <input
                      type="hidden"
                      name="_subject"
                      value="Offert förfrågan för {{ product.title }}"
                    >
                    <button
                      type="submit"
                      class="headline1 quote-submit-btn  flex w-full flex-row items-center justify-center gap-[15px] rounded-[10px] bg-[#EFD959] py-[14px] text-[18px] md:gap-[20px] md:text-[20px]"
                    >
                      Få ditt förslag
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="18"
                        height="14"
                        viewBox="0 0 18 14"
                        fill="none"
                      >
                        <path d="M1.66699 7.00009H16.667L10.7974 1.13049" stroke="#171717" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M1.66699 7.00004H16.667L10.7974 12.8696" stroke="#171717" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                    </button>
                  </form>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</section>

<!-- Cart Drawer -->
{% render 'cart-drawer' %}

{% stylesheet %}
  /* Make images passed with class image--cover fill and cover wrappers */
  .image.image--cover {
    width: 100%;
    height: 100%;
  }
  .image.image--cover > img {
    width: 100% !important;
    height: 100% !important;
    object-fit: contain !important;
  }

  /* Thumbnail active state */
  [data-thumbnail].active {
    opacity: 1 !important;
    border: 3px solid #171717 !important;
    transform: scale(1.05) !important;
    box-shadow: 0 4px 12px rgba(23, 23, 23, 0.2) !important;
  }

  /* Thumbnail hover state */
  [data-thumbnail]:hover:not(.active) {
    transform: scale(1.02);
    box-shadow: 0 2px 8px rgba(23, 23, 23, 0.15);
  }

  /* Smooth transitions for all thumbnail states */
  [data-thumbnail] {
    transition: all 0.3s ease;
  }

  /* Override hover opacity when active */
  [data-thumbnail].active:hover {
    opacity: 1 !important;
  }

  /* Metafield content styling - target H2 and H3 in rich text */
  .metafield-content h2 {
    font-size: 40px !important;
    line-height: 0.9 !important;
    margin: 0 0 16px 0 !important;
    font-weight: 400 !important;
    color: #171717 !important;
    display: block !important;
    font-family: var(--font-halyard--family);
  }

  .metafield-content h3 {
    font-size: 20px !important;
    line-height: 0.9 !important;
    margin: 0 0 30px 0 !important;
    font-weight: 400 !important;
    color: #171717 !important;
    font-family: var(--font-halyard--family);
  }

  .metafield-content p {
    margin: 0 0 12px 0 !important;
    color: #171717 !important;
    opacity: 0.8;
    display: block !important;
    font-family: var(--font-halyard--family);
  }

  .metafield-content ul,
  .metafield-content ol {
    margin: 0 0 12px 0 !important;
    padding-left: 20px !important;
    display: block !important;
  }

  .metafield-content li {
    margin: 0 0 6px 0 !important;
    color: #171717 !important;
    opacity: 0.8;
    display: list-item !important;
  }

  /* Ensure proper spacing between elements */
  .metafield-content > *:last-child {
    margin-bottom: 0 !important;
  }

  /* Dropdown styling */
  .dropdown-trigger {
    transition: all 0.3s ease;
  }

  .dropdown-icon {
    transition: transform 0.3s ease;
  }

  .dropdown-trigger.active .dropdown-icon {
    transform: rotate(45deg);
  }

  .dropdown-content {
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .dropdown-content.show {
    display: block !important;
  }

  /* Service option button styling */
  .service-option {
    transition: all 0.3s ease;
    border: 1px solid transparent;
  }

  .service-option:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(23, 23, 23, 0.1);
  }

  .service-option.bg-white {
    border-color: #e5e5e5;
  }

  .service-option.bg-\[#EFD959\] {
    border-color: #efd959;
    box-shadow: 0 2px 8px rgba(239, 217, 89, 0.3);
  }

  /* Upsell Products Styling */
  .upsell-product-card {
    transition: all 0.3s ease;
  }

  .upsell-product-card:hover {
    box-shadow: 0 4px 12px rgba(23, 23, 23, 0.1);
  }

  .upsell-checkbox,
  .installation-checkbox {
    accent-color: #171717;
    border-radius: 4px;
    border: 2px solid #171717;
  }

  .upsell-checkbox:hover,
  .installation-checkbox:hover {
    transform: scale(1.1);
  }

  .upsell-checkbox:checked,
  .installation-checkbox:checked {
    background-color: #171717;
  }

  .upsell-product-card:has(.upsell-checkbox:checked) {
    background-color: #f9fafb;
    border-color: #4ade80;
    border-width: 2px;
  }

  /* Installation Card Styling */
  .installation-card {
    transition: all 0.3s ease;
    background-color: #F3F1E8;
  }

  .installation-card:hover {
    box-shadow: 0 4px 12px rgba(23, 23, 23, 0.1);
  }

  .installation-card:has(.installation-checkbox:checked) {
    background-color: #F3F1E8;
    border-color: #EBCF2F;
    border-width: 2px;
  }

  .installation-card:has(.installation-checkbox:not(:checked)) {
    background-color: #ffffff;
    opacity: 0.7;
  }

  /* Green Deduction Radio Styling */
  .green-deduction-radio {
    accent-color: #4ade80;
    border-radius: 50%;
    border: 2px solid #171717;
    cursor: pointer;
  }

  .green-deduction-radio:hover {
    transform: scale(1.1);
  }

  .green-deduction-option {
    cursor: pointer;
  }

  .green-deduction-option:has(.green-deduction-radio:checked) {
    background: linear-gradient(135deg, #d4f1d4 0%, #e8f5e8 100%);
    border-color: #4ade80 !important;
    border-width: 2px;
  }

  .green-deduction-wrapper {
    transition: all 0.4s ease;
    overflow: hidden;
  }
{% endstylesheet %}

<!-- Generate product media data -->
<script type="application/json" id="product-media-data">
[
  {% for media in product.media %}
    {
      "id": {{ media.id }},
      "alt": {{ media.alt | default: product.title | json }},
      "src": {{ media | image_url: width: 600 | json }},
      "isFeatured": {% if forloop.first %}true{% else %}false{% endif %}
    }{% unless forloop.last %},{% endunless %}
  {% endfor %}
]
</script>

<!-- Generate product variants data -->
<script type="application/json" id="product-variants-data">
{{ product.variants | json }}
</script>

{% javascript %}
  // Global dropdown toggle function for mobile-friendly interaction
  function toggleDropdown(contentId, trigger) {
    const content = document.getElementById(contentId);
    const icon = trigger.querySelector('.dropdown-icon');

    if (content.style.display === 'none' || content.style.display === '') {
      content.style.display = 'block';
      content.classList.add('show');
      trigger.classList.add('active');
    } else {
      content.style.display = 'none';
      content.classList.remove('show');
      trigger.classList.remove('active');
    }
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Variant Selection Logic
    const variantSelects = document.querySelectorAll('.variant-select');
    const buyNowBtn = document.querySelector('.buy-now-btn');
    const addToCartBtn = document.querySelector('.add-to-cart-btn');
    const priceDisplay = document.getElementById('current-price');
    const comparePriceDisplay = document.getElementById('compare-price');

    // Product variants data
    const productVariantsRaw = document.getElementById('product-variants-data');
    const productVariants = productVariantsRaw ? JSON.parse(productVariantsRaw.textContent) : [];

    // Function to find matching variant based on selected options
    function findMatchingVariant() {
      const selectedOptions = {};
      
      // Get selected values by position (option1, option2, option3)
      variantSelects.forEach(select => {
        const position = select.dataset.optionPosition;
        selectedOptions['option' + position] = select.value;
      });

      // Find variant where all options match
      return productVariants.find(variant => {
        return Object.keys(selectedOptions).every(optionKey => {
          return variant[optionKey] === selectedOptions[optionKey];
        });
      });
    }

    // Function to update variant
    function updateVariant() {
      const selectedVariant = findMatchingVariant();
      
      if (selectedVariant) {
        console.log('Selected variant:', selectedVariant.id, selectedVariant.title);
        
        // Update button data attributes
        if (buyNowBtn) {
          buyNowBtn.setAttribute('data-variant-id', selectedVariant.id);
        }
        if (addToCartBtn) {
          addToCartBtn.setAttribute('data-variant-id', selectedVariant.id);
        }

        // Update price display
        if (priceDisplay) {
          priceDisplay.textContent = new Intl.NumberFormat('sv-SE', {
            style: 'currency',
            currency: 'SEK'
          }).format(selectedVariant.price / 100);
        }

        // Update compare price
        if (comparePriceDisplay) {
          if (selectedVariant.compare_at_price && selectedVariant.compare_at_price > selectedVariant.price) {
            comparePriceDisplay.textContent = new Intl.NumberFormat('sv-SE', {
              style: 'currency',
              currency: 'SEK'
            }).format(selectedVariant.compare_at_price / 100);
            comparePriceDisplay.style.display = 'inline';
          } else {
            comparePriceDisplay.style.display = 'none';
          }
        }

        // Update URL
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set('variant', selectedVariant.id);
        window.history.replaceState({}, '', newUrl);
        console.log('Updated URL to:', newUrl.toString());
      } else {
        console.log('No matching variant found');
      }
    }

    // Add change listeners to variant selects
    variantSelects.forEach(select => {
      select.addEventListener('change', updateVariant);
    });

    const mainImageContainer = document.getElementById('main-product-image');
    const thumbnails = document.querySelectorAll('[data-thumbnail]');

    if (mainImageContainer && thumbnails.length > 0) {
      // Store all product media for easy access
      const productMediaRaw = document.getElementById('product-media-data');
      const productMedia = productMediaRaw ? JSON.parse(productMediaRaw.textContent) : [];

      // Function to update main image
      function updateMainImage(mediaId) {
        const media = productMedia.find(m => m.id === mediaId);
        if (!media) return;

        // Update the image source
        const img = mainImageContainer.querySelector('img');
        if (img) {
          img.src = media.src;
          img.alt = media.alt;
        }

        // Update active thumbnail
        thumbnails.forEach(thumb => {
          thumb.classList.remove('active');
          if (parseInt(thumb.dataset.mediaId) === mediaId) {
            thumb.classList.add('active');
          }
        });
      }

      // Add click listeners to thumbnails
      thumbnails.forEach(thumbnail => {
        thumbnail.addEventListener('click', function() {
          const mediaId = parseInt(this.dataset.mediaId);
          updateMainImage(mediaId);
        });
      });

      // Set initial active state for featured image
      if (productMedia.length > 0) {
        const featuredMedia = productMedia.find(m => m.isFeatured);
        if (featuredMedia) {
          const featuredThumbnail = Array.from(thumbnails).find(thumb =>
            parseInt(thumb.dataset.mediaId) === featuredMedia.id
          );

          if (featuredThumbnail) {
            featuredThumbnail.classList.add('active');
          }
        }
      }
    }

    // Installation and Green Deduction Functionality
    const installationCheckbox = document.getElementById('installation-checkbox');
    const greenDeductionWrapper = document.getElementById('green-deduction-wrapper');
    
    if (installationCheckbox && greenDeductionWrapper) {
      // Set initial visibility based on installation checkbox state
      greenDeductionWrapper.style.display = installationCheckbox.checked ? 'block' : 'none';

      // Show/hide green deduction options based on installation checkbox
      installationCheckbox.addEventListener('change', function() {
        if (this.checked) {
          greenDeductionWrapper.style.display = 'block';
        } else {
          greenDeductionWrapper.style.display = 'none';
          // Uncheck any selected green deduction option
          const greenDeductionRadios = document.querySelectorAll('.green-deduction-radio');
          greenDeductionRadios.forEach(radio => {
            radio.checked = false;
          });
        }
      });
    }

    // Function to get selected discount code
    function getSelectedDiscountCode() {
      const selectedRadio = document.querySelector('.green-deduction-radio:checked');
      const code = selectedRadio ? selectedRadio.dataset.discountCode : null;
      console.log('🔍 Checking for discount code:', code);
      return code;
    }

    // Persist discount selection immediately on radio change and notify cart
    const greenDeductionRadios = document.querySelectorAll('.green-deduction-radio');
    if (greenDeductionRadios && greenDeductionRadios.length > 0) {
      greenDeductionRadios.forEach((radio) => {
        radio.addEventListener('change', function() {
          const code = getSelectedDiscountCode();
          try {
            if (code) {
              sessionStorage.setItem('selectedDiscountCode', code);
            } else {
              sessionStorage.removeItem('selectedDiscountCode');
            }
          } catch (_) {}
          // Broadcast to cart drawer to update its display
          window.dispatchEvent(new CustomEvent('discount:update'));
        });
      });
    }

    // Upsell Products Functionality
    function getSelectedUpsells() {
      const selectedUpsells = [];
      const upsellCheckboxes = document.querySelectorAll('.upsell-checkbox:checked');
      
      upsellCheckboxes.forEach(checkbox => {
        selectedUpsells.push({
          id: checkbox.dataset.variantId,
          quantity: 1
        });
      });
      
      return selectedUpsells;
    }

    // Buy Now functionality with upsells and installation
    const buyNowBtn = document.querySelector('.buy-now-btn');
    let isBuyNowProcessing = false;
    
    if (buyNowBtn) {
      buyNowBtn.addEventListener('click', async function (e) {
        e.preventDefault();

        // Prevent duplicate clicks
        if (isBuyNowProcessing) {
          console.log('Already processing, please wait...');
          return;
        }

        const variantId = this.getAttribute('data-variant-id');
        const quantity = getSelectedQuantity();
        const upsells = getSelectedUpsells();
        const discountCode = getSelectedDiscountCode();

        console.log('🛒 Buy Now clicked!');
        console.log('📦 Variant ID:', variantId);
        console.log('🎁 Discount Code:', discountCode || 'None selected');

        // Store discount code in sessionStorage
        if (discountCode) {
          sessionStorage.setItem('selectedDiscountCode', discountCode);
          console.log('💾 Saved discount code to session:', discountCode);
        }
        
        // Show loading state
        const originalText = this.innerHTML;
        this.innerHTML = 'Behandlar...';
        this.disabled = true;
        isBuyNowProcessing = true;

        try {
          // Build items array with main product and upsells
          const items = [
            {
              id: variantId,
              quantity: quantity
            },
            ...upsells
          ];

          // Check if installation is selected
          const installationCheckbox = document.getElementById('installation-checkbox');
          if (installationCheckbox && installationCheckbox.checked) {
            const installationVariantId = installationCheckbox.dataset.variantId;
            // Add installation product to cart
            items.push({
              id: installationVariantId,
              quantity: 1
            });
          }

          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              items: items
            }),
          });

          if (response.ok) {
            // Go to checkout with discount code if selected
            if (discountCode) {
              const checkoutUrl = '/checkout?discount=' + discountCode;
              console.log('✅ Going to checkout with discount:', checkoutUrl);
              window.location.href = checkoutUrl;
            } else {
              console.log('✅ Going to checkout (no discount)');
              window.location.href = '/checkout';
            }
          } else if (response.status === 429) {
            throw new Error('För många förfrågningar. Vänta några sekunder och försök igen.');
          } else {
            const errorData = await response.json();
            throw new Error(errorData.description || 'Kunde inte lägga till i varukorgen');
          }
        } catch (error) {
          console.error('Error with buy now:', error);

          // Show error state with specific message
          this.innerHTML = error.message.includes('många') ? 'Vänta...' : 'Fel!';
          this.style.background = '#EF4444';
          this.style.color = 'white';

          // Reset button after appropriate delay
          const resetDelay = error.message.includes('många') ? 3000 : 2000;
          setTimeout(() => {
            this.innerHTML = originalText;
            this.disabled = false;
            this.style.background = '';
            this.style.color = '';
            isBuyNowProcessing = false;
          }, resetDelay);
        }
      });
    }

    // Add to Cart functionality with upsells and installation
    const addToCartBtn = document.querySelector('.add-to-cart-btn');
    let isAddToCartProcessing = false;
    
    if (addToCartBtn) {
      addToCartBtn.addEventListener('click', async function (e) {
        e.preventDefault();

        // Prevent duplicate clicks
        if (isAddToCartProcessing) {
          console.log('Already processing, please wait...');
          return;
        }

        const variantId = this.getAttribute('data-variant-id');
        const quantity = getSelectedQuantity();
        const upsells = getSelectedUpsells();
        const discountCode = getSelectedDiscountCode();

        console.log('🛒 Add to Cart clicked!');
        console.log('🎁 Discount Code:', discountCode || 'None selected');

        // Store discount code in sessionStorage so cart drawer can use it
        if (discountCode) {
          sessionStorage.setItem('selectedDiscountCode', discountCode);
          console.log('💾 Saved discount code to session:', discountCode);
        }

        // Show loading state
        const originalText = this.innerHTML;
        this.innerHTML = 'Lägger till...';
        this.disabled = true;
        isAddToCartProcessing = true;

        try {
          // Build items array with main product and upsells
          const items = [
            {
              id: variantId,
              quantity: quantity
            },
            ...upsells
          ];

          // Check if installation is selected
          const installationCheckbox = document.getElementById('installation-checkbox');
          if (installationCheckbox && installationCheckbox.checked) {
            const installationVariantId = installationCheckbox.dataset.variantId;
            // Add installation product to cart
            items.push({
              id: installationVariantId,
              quantity: 1
            });
          }

          const response = await fetch('/cart/add.js', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              items: items
            }),
          });

          if (response.ok) {
            // Update cart count and show success
            const cartData = await response.json();
            
            // Show success state
            this.innerHTML = 'Tillagd! ✓';
            this.style.background = '#4ade80';
            this.style.color = 'white';

            // Trigger cart update event for cart.js to reload
            window.dispatchEvent(new CustomEvent('cart:update'));
            
            // Open cart drawer if available
            const cartDrawer = document.getElementById('cart-drawer');
            const cartOverlay = document.querySelector('[data-cart-overlay]');
            if (cartDrawer) {
              cartDrawer.classList.add('open');
              if (cartOverlay) {
                cartOverlay.classList.add('active');
              }
              document.body.style.overflow = 'hidden';
            }

            // Reset button after 2 seconds
            setTimeout(() => {
              this.innerHTML = originalText;
              this.disabled = false;
              this.style.background = '';
              this.style.color = '';
              isAddToCartProcessing = false;
            }, 2000);
          } else if (response.status === 429) {
            throw new Error('För många förfrågningar. Vänta några sekunder och försök igen.');
          } else {
            const errorData = await response.json();
            throw new Error(errorData.description || 'Kunde inte lägga till i varukorgen');
          }
        } catch (error) {
          console.error('Error adding to cart:', error);

          // Show error state with specific message
          this.innerHTML = error.message.includes('många') ? 'Vänta...' : 'Fel!';
          this.style.background = '#EF4444';
          this.style.color = 'white';

          // Reset button after appropriate delay
          const resetDelay = error.message.includes('många') ? 3000 : 2000;
          setTimeout(() => {
            this.innerHTML = originalText;
            this.disabled = false;
            this.style.background = '';
            this.style.color = '';
            isAddToCartProcessing = false;
          }, resetDelay);
        }
      });
    }
  });
{% endjavascript %}

{% schema %}
{
  "name": "Produkt",
  "settings": [
    {
      "type": "header",
      "content": "Installation"
    },
    {
      "type": "checkbox",
      "id": "show_installation",
      "label": "Visa installation",
      "default": false
    },
    {
      "type": "product",
      "id": "installation_product",
      "label": "Välj installation produkt",
      "info": "Välj produkten som ska användas för installation"
    },
    {
      "type": "text",
      "id": "installation_title",
      "label": "Anpassad titel (valfri)",
      "info": "Lämna tom för att använda produkttitel"
    },
    {
      "type": "textarea",
      "id": "installation_description",
      "label": "Anpassad beskrivning (valfri)",
      "info": "Lämna tom för att använda produktbeskrivning"
    },
    {
      "type": "header",
      "content": "Grönt avdrag 1"
    },
    {
      "type": "text",
      "id": "green_deduction_1_title",
      "label": "Titel",
      "default": "Grönt avdrag 1",
      "info": "Visas endast om installation är vald. Rabattkod: AVDRAG1"
    },
    {
      "type": "textarea",
      "id": "green_deduction_1_description",
      "label": "Beskrivning",
      "default": "Få upp till 50% rabatt på arbetskostnaden med grönt avdrag (ROT)."
    },
    {
      "type": "header",
      "content": "Grönt avdrag 2"
    },
    {
      "type": "text",
      "id": "green_deduction_2_title",
      "label": "Titel",
      "default": "Grönt avdrag 2",
      "info": "Visas endast om installation är vald. Rabattkod: AVDRAG2"
    },
    {
      "type": "textarea",
      "id": "green_deduction_2_description",
      "label": "Beskrivning",
      "default": "Alternativ grönt avdrag med andra villkor."
    }
  ],
  "blocks": [
    {
      "type": "upsell_product",
      "name": "Upsell produkt",
      "settings": [
        {
          "type": "product",
          "id": "upsell_product",
          "label": "Välj produkt"
        },
        {
          "type": "text",
          "id": "upsell_title",
          "label": "Anpassad titel",
          "info": "Lämna tom för att använda produkttitel"
        },
        {
          "type": "textarea",
          "id": "upsell_description",
          "label": "Beskrivning",
          "info": "Förklara varför kunden bör lägga till denna produkt"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Produkt"
    }
  ]
}
{% endschema %}
